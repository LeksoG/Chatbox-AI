<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI - Enhanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #5046E5;
            --primary-light: #6366F1;
            --primary-dark: #4338CA;
            --secondary: #F9FAFB;
            --text: #1F2937;
            --text-light: #6B7280;
            --white: #FFFFFF;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.06);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
            --border-radius: 20px;
            --sidebar-width: 360px;
            --message-spacing: 28px;
            --header-height: 70px;
            --footer-height: 90px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
            height: var(--header-height);
            position: relative;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 14px;
            background-color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }
        
        .avatar:hover {
            transform: scale(1.05);
        }
        
        .avatar svg {
            width: 24px;
            height: 24px;
            color: var(--primary);
        }
        
        .title h1 {
            font-size: 20px;
            margin-bottom: 2px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .title p {
            font-size: 13px;
            opacity: 0.9;
            letter-spacing: 0.2px;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 3px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            background-color: #10B981;
            border-radius: 50%;
        }
        
        .status-text {
            font-size: 12px;
        }
        
        .actions {
            display: flex;
            gap: 20px;
        }
        
        .actions svg {
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .actions svg:hover {
            transform: scale(1.1);
            opacity: 0.9;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            scroll-behavior: smooth;
            background-color: #FCFCFC;
            background-image: 
                radial-gradient(circle at 25px 25px, rgba(0, 0, 0, 0.01) 2%, transparent 2%),
                radial-gradient(circle at 75px 75px, rgba(0, 0, 0, 0.01) 2%, transparent 2%);
            background-size: 100px 100px;
            display: flex;
            flex-direction: column;
            gap: var(--message-spacing);
            height: calc(100vh - var(--header-height) - var(--footer-height));
        }
        
        .message {
            max-width: 85%;
            animation: fadeIn 0.4s ease;
            position: relative;
        }
        
        .message.bot {
            margin-right: auto;
            padding-left: 52px;
        }
        
        .message.user {
            margin-left: auto;
            padding-right: 52px;
        }
        
        .message-avatar {
            position: absolute;
            left: 0;
            top: 0;
            width: 38px;
            height: 38px;
            border-radius: 12px;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .user-avatar {
            position: absolute;
            right: 0;
            top: 0;
            width: 38px;
            height: 38px;
            border-radius: 12px;
            background-color: #10B981;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .message-content {
            padding: 18px 22px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            position: relative;
            transition: var(--transition);
            font-size: 15px;
            line-height: 1.6;
        }
        
        .message-content:hover {
            box-shadow: 0 6px 8px -2px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        
        .message.bot .message-content {
            background-color: var(--white);
            border-bottom-left-radius: 4px;
            color: var(--text);
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            border-bottom-right-radius: 4px;
        }
        
        .message-time {
            font-size: 11px;
            margin-top: 6px;
            opacity: 0.7;
            text-align: right;
        }
        
        .message-actions {
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .message:hover .message-actions {
            opacity: 1;
        }
        
        .message-action-button {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--white);
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .message-action-button:hover {
            background: var(--primary-light);
            color: white;
            transform: scale(1.1);
        }
        
        .message-action-button svg {
            width: 16px;
            height: 16px;
        }
        
        .input-container {
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            background-color: var(--white);
            position: relative;
            height: var(--footer-height);
        }
        
        .input-field {
            flex: 1;
            position: relative;
            background: var(--secondary);
            border-radius: 24px;
            transition: var(--transition);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .input-field:focus-within {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: var(--white);
        }
        
        textarea {
            width: 100%;
            padding: 16px 50px 16px 18px;
            border-radius: 24px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 15px;
            resize: none;
            height: 58px;
            max-height: 150px;
            transition: var(--transition);
            outline: none;
            background: transparent;
            color: var(--text);
        }
        
        textarea:focus {
            border-color: var(--primary-light);
        }
        
        .send-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .send-button:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .send-button svg {
            width: 20px;
            height: 20px;
        }
        
        .features {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .feature-button {
            background: var(--secondary);
            border: none;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .feature-button:hover {
            color: var(--primary);
            background-color: #F1F5F9;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .feature-button svg {
            width: 22px;
            height: 22px;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 12px 16px;
            background-color: var(--secondary);
            border-radius: 16px;
            width: fit-content;
            box-shadow: var(--card-shadow);
            margin-left: 52px;
            z-index: 5;
            margin-top: 8px;
            position: relative;
        }
        
        .typing-indicator.active {
            opacity: 1;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--primary);
            border-radius: 50%;
        }
        
        .typing-dot:nth-child(1) {
            animation: bounce 1s infinite 0.1s;
        }
        
        .typing-dot:nth-child(2) {
            animation: bounce 1s infinite 0.3s;
        }
        
        .typing-dot:nth-child(3) {
            animation: bounce 1s infinite 0.5s;
        }
        
        /* Enhanced voice interface */
        .voice-input-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.4s ease, z-index 0s 0.4s;
        }
        
        .voice-input-overlay.active {
            opacity: 1;
            z-index: 100;
            transition: opacity 0.4s ease, z-index 0s;
        }
        
        .voice-input-container {
            position: relative;
            width: 80%;
            max-width: 800px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--primary-light);
            border-radius: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            transform: translateY(30px);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .voice-input-overlay.active .voice-input-container {
            transform: translateY(0);
            opacity: 1;
        }
        
        .voice-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .voice-close-button:hover {
            background-color: #F3F4F6;
            color: var(--text);
        }
        
        .voice-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.3);
            color: white;
            position: relative;
        }
        
        .voice-icon svg {
            width: 36px;
            height: 36px;
        }
        
        .voice-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.3);
            opacity: 0;
            transform: scale(1);
        }
        
        .voice-pulse.animate {
            animation: pulse 1.5s ease-out infinite;
        }
        
        .voice-visualization {
            height: 60px;
            width: 100%;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .voice-visualization:before {
            content: "You";
            position: absolute;
            left: 10px;
            font-weight: bold;
            color: #10B981;
        }
        
        .voice-visualization:after {
            content: "Nexus";
            position: absolute;
            right: 10px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .voice-wave {
            display: flex;
            align-items: center;
            width: 80%;
            justify-content: space-between;
        }
        
        .voice-bar {
            width: 4px;
            height: 20px;
            background-color: var(--primary-light);
            border-radius: 2px;
            transition: height 0.2s ease;
        }
        
        .voice-flow {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            left: 40px;
            transform: translateX(0);
            opacity: 0;
            transition: transform 1.5s ease-in-out, opacity.5s ease-in-out;
        }
        
        .voice-flow.animate {
            animation: flowAnimation 2s infinite;
        }
        
        .voice-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }
        
        .voice-transcript {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 32px;
            min-height: 100px;
            color: var(--text);
            background-color: var(--secondary);
            padding: 16px;
            border-radius: 12px;
            text-align: left;
        }
        
        .voice-controls {
            display: flex;
            justify-content: center;
            gap: 16px;
        }
        
        .voice-button {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .voice-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.2);
        }
        
        .voice-cancel {
            background-color: #F3F4F6;
            color: var(--text);
        }
        
        .voice-send {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }
        
        .voice-cancel:hover {
            background-color: #E5E7EB;
        }
        
        .voice-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Emoji Picker */
        .emoji-picker {
            position: absolute;
            bottom: 100px;
            left: 24px;
            width: 320px;
            height: 350px;
            background-color: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 16px;
            display: none;
            flex-direction: column;
            z-index: 10;
            animation: fadeIn 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .emoji-picker.active {
            display: flex;
        }
        
        .emoji-tabs {
            display: flex;
            margin-bottom: 10px;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        
        .emoji-tab {
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            white-space: nowrap;
        }
        
        .emoji-tab.active {
            background-color: var(--primary-light);
            color: var(--white);
        }
        
        .emoji-tab:hover:not(.active) {
            background-color: var(--secondary);
        }
        
        .emoji-content {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .emoji {
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            cursor: pointer;
            border-radius: 8px;
            transition: var(--transition);
        }
        
        .emoji:hover {
            background-color: var(--secondary);
            transform: scale(1.2);
        }
        
        /* Emoji Suggestions */
        .emoji-suggestions {
            position: absolute;
            bottom: 90px;
            left: 84px;
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 8px 12px;
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            z-index: 10;
            animation: fadeIn 0.2s ease;
            border: 1px solid rgba(0, 0, 0, 0.1);
            max-width: 300px;
        }
        
        .emoji-suggestions.active {
            display: flex;
        }
        
        .emoji-suggestion {
            font-size: 22px;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: var(--transition);
        }
        
        .emoji-suggestion:hover {
            background-color: var(--secondary);
            transform: scale(1.2);
        }
        
        /* Settings Sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 20;
            backdrop-filter: blur(2px);
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .settings-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: var(--sidebar-width);
            height: 100%;
            background-color: var(--white);
            transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 30;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .settings-sidebar.active {
            right: 0;
        }
        
        .sidebar-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
        }
        
        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .sidebar-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .sidebar-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .sidebar-content {
            flex: 1;
            padding: 20px 24px;
        }
        
        .settings-section {
            margin-bottom: 28px;
        }
        
        .settings-section h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: var(--text);
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .theme-options {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .theme-option {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition);
        }
        
        .theme-option.active {
            border-color: var(--primary);
            transform: scale(1.1);
        }
        
        .theme-option:hover:not(.active) {
            transform: scale(1.05);
        }
        
        .theme-purple {
            background: linear-gradient(135deg, #5046E5 0%, #6366F1 100%);
        }
        
        .theme-blue {
            background: linear-gradient(135deg, #0EA5E9 0%, #38BDF8 100%);
        }
        
        .theme-green {
            background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
        }
        
        .theme-rose {
            background: linear-gradient(135deg, #F43F5E 0%, #FB7185 100%);
        }
        
        .theme-amber {
            background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
        }
        
        .theme-violet {
            background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);
        }
        
        .theme-cyan {
            background: linear-gradient(135deg, #06B6D4 0%, #22D3EE 100%);
        }
        
        .theme-emerald {
            background: linear-gradient(135deg, #059669 0%, #10B981 100%);
        }
        
        .toggle-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
        }
        
        .toggle-label {
            font-size: 15px;
            color: var(--text);
        }
        
        .toggle-description {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
            max-width: 70%;
            line-height: 1.5;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
            flex-shrink: 0;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #E5E7EB;
            transition: var(--transition);
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        input:focus + .toggle-slider {
            box-shadow: 0 0 1px var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        .range-option {
            margin-bottom: 16px;
        }
        
        .range-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .range-label {
            font-size: 15px;
            color: var(--text);
        }
        
        .range-value {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
        }
        
        .range-slider {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            background: #E5E7EB;
            border-radius: 5px;
            outline: none;
        }
        
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        
        .font-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .font-option {
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--secondary);
            border: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .font-option.active {
            background: var(--primary);
            color: white;
        }
        
        .font-option:hover:not(.active) {
            background: #F1F5F9;
        }
        
        /* Option groups */
        .option-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .radio-option {
            position: relative;
            cursor: pointer;
        }
        
        .radio-option input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .radio-design {
            padding: 12px 14px;
            border-radius: 10px;
            background: var(--secondary);
            border: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            text-align: center;
        }
        
        .radio-icon {
            margin-bottom: 8px;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .radio-icon svg {
            width: 24px;
            height: 24px;
        }
        
        .radio-label {
            font-size: 13px;
            color: var(--text);
            transition: var(--transition);
        }
        
        .radio-option input:checked + .radio-design {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
        }
        
        .radio-option input:checked + .radio-design .radio-icon {
            color: var(--primary);
        }
        
        .sidebar-footer {
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .sidebar-button {
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .cancel-button {
            background-color: #F3F4F6;
            border: 1px solid #E5E7EB;
            color: var(--text);
        }
        
        .save-button {
            background-color: var(--primary);
            border: 1px solid var(--primary);
            color: white;
            padding: 10px 20px;
        }
        
        .cancel-button:hover {
            background-color: #E5E7EB;
        }
        
        .save-button:hover {
            background-color: var(--primary-dark);
        }
        
        /* Welcome screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            padding: 20px;
            color: var(--text-light);
        }
        
        .welcome-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            box-shadow: 0 10px 25px -5px rgba(80, 70, 229, 0.3);
        }
        
        .welcome-icon svg {
            width: 40px;
            height: 40px;
            color: white;
        }
        
        .welcome-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text);
        }
        
        .welcome-description {
            max-width: 600px;
            margin-bottom: 32px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        /* Glow effect */
        .glow-container {
            position: absolute;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.2) 0%, rgba(99, 102, 241, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        /* Animation classes for typing effect */
        .typing-animation {
            overflow: hidden;
            white-space: break-spaces;
            animation: none;
            width: 100%;
        }
        
        .typing-animation.animate {
            animation: typing-effect 1s ease-out;
        }
        
        /* History modal styles */
        .history-modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .history-modal-content {
            background-color: var(--white);
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .history-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 10px;
        }
        
        .history-session {
            background-color: var(--secondary);
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .history-session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-date {
            color: var(--text-light);
            font-size: 0.8em;
        }
        
        .restore-session {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .empty-history, .error-history {
            text-align: center;
            color: var(--text-light);
            padding: 20px;
        }
        
        /* Make sure these animations are properly defined in your CSS */
        @keyframes typing-effect {
            from { max-height: 0; opacity: 0; }
            to { max-height: 1000px; opacity: 1; }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.6);
                opacity: 0;
            }
        }
        
        @keyframes flowAnimation {
            0% {
                transform: translateX(0);
                opacity: 0.7;
                width: 10px;
                height: 10px;
            }
            50% {
                opacity: 1;
                width: 15px;
                height: 15px;
            }
            100% {
                transform: translateX(calc(100% - 40px));
                opacity: 0.7;
                width: 10px;
                height: 10px;
            }
        }
        
        /* Animations */
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Scrollbar styling */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 20px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100%;
                --message-spacing: 20px;
            }
            
            .settings-sidebar {
                right: -100%;
            }
            
            .message {
                max-width: 90%;
            }
            
            .chat-container {
                padding: 20px;
            }
            
            .message-actions {
                right: -30px;
            }
            
            .message-action-button {
                width: 28px;
                height: 28px;
            }
            
            .message-action-button svg {
                width: 14px;
                height: 14px;
            }
            
            .voice-input-container {
                width: 95%;
                padding: 24px;
            }
        }
        
        @media (max-width: 480px) {
            .features button:not(:first-child) {
                display: none;
            }
            
            .header {
                padding: 12px 16px;
            }
            
            .title h1 {
                font-size: 18px;
            }
            
            .title p {
                font-size: 12px;
            }
            
            .avatar {
                width: 36px;
                height: 36px;
            }
            
            .message.bot {
                padding-left: 40px;
            }
            
            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .message-content {
                padding: 14px 16px;
            }

            /* Export dropdown styles */
.export-dropdown {
    position: absolute;
    top: 60px;
    right: 24px;
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow);
    width: 200px;
    padding: 8px;
    display: none;
    flex-direction: column;
    gap: 6px;
    z-index: 20;
    overflow: hidden;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.export-dropdown.active {
    display: flex;
    animation: slideDown 0.3s ease forwards;
}

.export-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    background: transparent;
    color: var(--text);
    cursor: pointer;
    transition: var(--transition);
    text-align: left;
    font-weight: 500;
}

.export-option svg {
    width: 18px;
    height: 18px;
    color: var(--primary);
}

.export-option:hover {
    background: var(--secondary);
}

/* Summary overlay styles */
.summary-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.summary-overlay.active {
    opacity: 1;
}

.summary-container {
    background-color: var(--white);
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 90%;
    overflow-y: auto;
    box-shadow: var(--shadow);
    transform: translateY(20px);
    transition: transform 0.4s ease;
}

.summary-overlay.active .summary-container {
    transform: translateY(0);
}

.summary-header {
    padding: 16px 20px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background-color: var(--white);
    z-index: 1;
}

.summary-header h2 {
    font-size: 18px;
    margin: 0;
    color: var(--text);
}

.summary-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-light);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: var(--transition);
}

.summary-close:hover {
    background-color: rgba(0, 0, 0, 0.05);
    color: var(--text);
}

.summary-content {
    padding: 20px;
}

.summary-section {
    margin-bottom: 24px;
}

.summary-section h3 {
    font-size: 16px;
    margin-bottom: 12px;
    color: var(--primary);
}

.summary-section ul {
    padding-left: 20px;
    margin: 0;
}

.summary-section li {
    margin-bottom: 8px;
}

.summary-footer {
    padding: 16px 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.summary-download, .summary-copy {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    background-color: var(--primary);
    color: white;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
}

.summary-download:hover, .summary-copy:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
}

/* Action Items Overlay */
.action-items-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.action-items-overlay.active {
    opacity: 1;
}

.action-items-container {
    background-color: var(--white);
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 90%;
    overflow-y: auto;
    box-shadow: var(--shadow);
    transform: translateY(20px);
    transition: transform 0.4s ease;
}

/* Keyboard Shortcuts Overlay */
.keyboard-shortcuts-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.keyboard-shortcuts-overlay.active {
    opacity: 1;
}

.keyboard-shortcuts-container {
    background-color: var(--white);
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 90%;
    overflow-y: auto;
    box-shadow: var(--shadow);
    transform: translateY(20px);
    transition: transform 0.4s ease;
}

.shortcuts-header {
    padding: 16px 20px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.shortcuts-section {
    padding: 16px 20px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.shortcut-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
}

.key {
    display: inline-block;
    padding: 2px 8px;
    background-color: #f1f5f9;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    font-size: 12px;
    font-weight: 500;
}
        }

        /* Logo Animation Styles */
.logo-animation-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    background-color: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(5px);
    opacity: 1;
    transition: opacity 0.8s ease;
}

.logo-animation-container.fade-out {
    opacity: 0;
    pointer-events: none;
}

.logo-animation {
    position: relative;
    width: 120px;
    height: 120px;
    transform-origin: center;
    transition: all 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}

.logo-animation.move-to-corner {
    transform: scale(0.35) translate(-150px, -150px);
    position: absolute;
    top: 20px;
    left: 20px;
}

.logo-circle {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 30%;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    box-shadow: 0 10px 25px rgba(80, 70, 229, 0.3);
    animation: pulse-glow 2s infinite alternate;
}

.logo-inner {
    position: absolute;
    width: 70%;
    height: 70%;
    top: 15%;
    left: 15%;
    border-radius: 18%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
}

.logo-core {
    width: 60%;
    height: 60%;
    background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
    border-radius: 12px;
    position: relative;
    animation: rotate 3s infinite linear;
}

.logo-dot {
    position: absolute;
    width: 15%;
    height: 15%;
    border-radius: 50%;
    background: white;
}

.logo-dot-1 {
    top: 15%;
    left: 15%;
    animation: dot-pulse 1.5s infinite alternate;
}

.logo-dot-2 {
    top: 15%;
    right: 15%;
    animation: dot-pulse 1.5s infinite alternate 0.3s;
}

.logo-dot-3 {
    bottom: 15%;
    left: 15%;
    animation: dot-pulse 1.5s infinite alternate 0.6s;
}

.logo-dot-4 {
    bottom: 15%;
    right: 15%;
    animation: dot-pulse 1.5s infinite alternate 0.9s;
}

.logo-lines {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    animation: wave-lines 3s infinite linear;
}

.logo-line {
    position: absolute;
    height: 2px;
    width: 20px;
    background: rgba(255, 255, 255, 0.6);
}

/* Create lines in a circle pattern */
.logo-line:nth-child(1) { 
    top: 30px; 
    left: -10px; 
    transform: rotate(30deg);
    animation: pulse-line 2s infinite alternate 0.1s;
}
.logo-line:nth-child(2) { 
    top: -10px; 
    left: 30px; 
    transform: rotate(120deg);
    animation: pulse-line 2s infinite alternate 0.2s;
}
.logo-line:nth-child(3) { 
    top: 110px; 
    left: 30px; 
    transform: rotate(60deg);
    animation: pulse-line 2s infinite alternate 0.3s;
}
.logo-line:nth-child(4) { 
    top: 30px; 
    left: 110px; 
    transform: rotate(150deg);
    animation: pulse-line 2s infinite alternate 0.4s;
}
.logo-line:nth-child(5) { 
    top: 60px; 
    left: -15px; 
    transform: rotate(0deg);
    animation: pulse-line 2s infinite alternate 0.5s;
}
.logo-line:nth-child(6) { 
    top: -15px; 
    left: 60px; 
    transform: rotate(90deg);
    animation: pulse-line 2s infinite alternate 0.6s;
}

/* Logo animation keyframes */
@keyframes rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes dot-pulse {
    0% { transform: scale(1); opacity: 0.7; }
    100% { transform: scale(1.5); opacity: 1; }
}

@keyframes pulse-glow {
    0% { box-shadow: 0 0 15px rgba(80, 70, 229, 0.5); }
    100% { box-shadow: 0 0 30px rgba(80, 70, 229, 0.8); }
}

@keyframes wave-lines {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes pulse-line {
    0% { opacity: 0.2; width: 15px; }
    100% { opacity: 0.8; width: 25px; }
}

.logo-text {
    position: absolute;
    bottom: -40px;
    font-size: 24px;
    font-weight: 700;
    background: linear-gradient(to right, var(--primary) 0%, var(--primary-light) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    opacity: 0;
    transform: translateY(20px);
    animation: fade-slide-up 0.8s forwards 0.5s;
}

@keyframes fade-slide-up {
    0% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 1; transform: translateY(0); }
}

.header-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
    border-radius: 14px;
    background: #fca311; /* Match your yellow header background */
    margin-right: 14px;
    position: relative;
    overflow: hidden;
    opacity: 0;
    transition: opacity 0.5s ease;
    flex-shrink: 0; /* Prevent logo from shrinking */
}

.header-logo.visible {
    opacity: 1;
}

.header-logo-icon {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    position: relative;
}

.header-logo-dot {
    position: absolute;
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: white;
}

.header-logo-dot-1 {
    top: 5px;
    left: 5px;
}

.header-logo-dot-2 {
    top: 5px;
    right: 5px;
}

.header-logo-dot-3 {
    bottom: 5px;
    left: 5px;
}

.header-logo-dot-4 {
    bottom: 5px;
    right: 5px;
}

.header {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
    }
    
    .actions {
        display: flex !important;
        gap: 20px !important;
    }
    
    /* Ensure buttons remain visible */
    .actions svg, .feature-button {
        visibility: visible !important;
        opacity: 1 !important;
    }
    </style>
</head>
<body>
    <div class="container">
        <!-- Logo Animation Container -->
<div class="logo-animation-container" id="logoAnimContainer">
    <div class="logo-animation" id="logoAnimation">
        <div class="logo-circle"></div>
        <div class="logo-inner">
            <div class="logo-core">
                <div class="logo-dot logo-dot-1"></div>
                <div class="logo-dot logo-dot-2"></div>
                <div class="logo-dot logo-dot-3"></div>
                <div class="logo-dot logo-dot-4"></div>
            </div>
        </div>
        <div class="logo-lines">
            <div class="logo-line"></div>
            <div class="logo-line"></div>
            <div class="logo-line"></div>
            <div class="logo-line"></div>
            <div class="logo-line"></div>
            <div class="logo-line"></div>
        </div>
        <div class="logo-text">Nexus AI</div>
    </div>
</div>
        <div class="glow-container"></div>
        
        <div class="header">
      <div class="header-content">
    <div class="header-logo" id="headerLogo">
        <div class="header-logo-icon">
            <div class="header-logo-dot header-logo-dot-1"></div>
            <div class="header-logo-dot header-logo-dot-2"></div>
            <div class="header-logo-dot header-logo-dot-3"></div>
            <div class="header-logo-dot header-logo-dot-4"></div>
        </div>
    </div>
    <!-- Original avatar should still be here but initially hidden -->
    <div class="avatar" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
        </svg>
    </div>
    <div class="title">
        <h1>Nexus AI</h1>
        <p>Your intelligent assistant</p>
        <div class="status">
            <div class="status-dot"></div>
            <div class="status-text">Online</div>
        </div>
    </div>
</div>
            <div class="actions">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="settingsButton">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </div>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                    </svg>
                </div>
                <h2 class="welcome-title">Welcome to Nexus AI</h2>
                <p class="welcome-description">I'm your intelligent AI assistant, ready to help answer questions, provide information, and assist with various tasks. Type a message below to start our conversation.</p>
            </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
        
        <div class="input-container">
            <div class="features">
                <button class="feature-button" id="emojiButton" title="Add Emoji">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
                <button class="feature-button" id="voiceButton" title="Voice Input">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </button>
                <button class="feature-button" id="attachButton" title="Attach Files">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                    </svg>
                </button>
            </div>
            
            <div class="input-field">
                <textarea id="userInput" placeholder="Type your message..." rows="1"></textarea>
                <button class="send-button" id="sendButton">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" transform="rotate(90 12 12)" />
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Emoji Picker -->
        <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-tabs">
                <div class="emoji-tab active">Frequently Used</div>
                <div class="emoji-tab">Smileys</div>
                <div class="emoji-tab">People</div>
                <div class="emoji-tab">Animals</div>
                <div class="emoji-tab">Food</div>
                <div class="emoji-tab">Activities</div>
                <div class="emoji-tab">Travel</div>
                <div class="emoji-tab">Objects</div>
                <div class="emoji-tab">Symbols</div>
            </div>
            <div class="emoji-content">
                <div class="emoji" data-emoji="😊">😊</div>
                <div class="emoji" data-emoji="👍">👍</div>
                <div class="emoji" data-emoji="🙌">🙌</div>
                <div class="emoji" data-emoji="🎉">🎉</div>
                <div class="emoji" data-emoji="🔥">🔥</div>
                <div class="emoji" data-emoji="❤️">❤️</div>
                <div class="emoji" data-emoji="😂">😂</div>
                <div class="emoji" data-emoji="🤔">🤔</div>
                <div class="emoji" data-emoji="👏">👏</div>
                <div class="emoji" data-emoji="✨">✨</div>
                <div class="emoji" data-emoji="😍">😍</div>
                <div class="emoji" data-emoji="🙏">🙏</div>
                <div class="emoji" data-emoji="👀">👀</div>
                <div class="emoji" data-emoji="💯">💯</div>
                <div class="emoji" data-emoji="⭐">⭐</div>
                <div class="emoji" data-emoji="🤩">🤩</div>
                <div class="emoji" data-emoji="🙄">🙄</div>
                <div class="emoji" data-emoji="😎">😎</div>
                <div class="emoji" data-emoji="🤗">🤗</div>
                <div class="emoji" data-emoji="😁">😁</div>
                <div class="emoji" data-emoji="😉">😉</div>
                <div class="emoji" data-emoji="🚀">🚀</div>
                <div class="emoji" data-emoji="💪">💪</div>
                <div class="emoji" data-emoji="🌈">🌈</div>
                <div class="emoji" data-emoji="🎊">🎊</div>
                <div class="emoji" data-emoji="🌟">🌟</div>
                <div class="emoji" data-emoji="💖">💖</div>
                <div class="emoji" data-emoji="👋">👋</div>
                <div class="emoji" data-emoji="🌞">🌞</div>
                <div class="emoji" data-emoji="🤖">🤖</div>
            </div>
        </div>
        
        <!-- Emoji Suggestions Container -->
        <div class="emoji-suggestions" id="emojiSuggestions"></div>
        
        <!-- Settings Sidebar and Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <div class="settings-sidebar" id="settingsSidebar">
            <div class="sidebar-header">
                <h2>Settings</h2>
                <button class="sidebar-close" id="sidebarClose">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="sidebar-content">
                <div class="settings-section">
                    <h3>Theme Color</h3>
                    <div class="theme-options">
                        <div class="theme-option theme-purple active" data-theme="purple"></div>
                        <div class="theme-option theme-blue" data-theme="blue"></div>
                        <div class="theme-option theme-green" data-theme="green"></div>
                        <div class="theme-option theme-rose" data-theme="rose"></div>
                        <div class="theme-option theme-amber" data-theme="amber"></div>
                        <div class="theme-option theme-violet" data-theme="violet"></div>
                        <div class="theme-option theme-cyan" data-theme="cyan"></div>
                        <div class="theme-option theme-emerald" data-theme="emerald"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Interface Options</h3>
                    
                    <div class="toggle-option">
                        <div>
                            <span class="toggle-label">Dark Mode</span>
                            <p class="toggle-description">Switch to dark theme for low-light environments</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-option">
                        <div>
                            <span class="toggle-label">Sound Effects</span>
                            <p class="toggle-description">Play sounds for messages and notifications</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-option">
                        <div>
                            <span class="toggle-label">Typing Animation</span>
                            <p class="toggle-description">Show typing indicator and text animation</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="typingAnimToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-option">
                        <div>
                            <span class="toggle-label">Auto Scroll</span>
                            <p class="toggle-description">Automatically scroll to newest messages</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoScrollToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Text Options</h3>
                    
                    <div class="range-option">
                        <div class="range-header">
                            <span class="range-label">Font Size</span>
                            <span class="range-value" id="fontSizeValue">Medium</span>
                        </div>
                        <input type="range" min="1" max="5" value="3" class="range-slider" id="fontSizeRange">
                    </div>
                    
                    <div class="font-options">
                        <div class="font-option active" data-font="system">System</div>
                        <div class="font-option" data-font="serif">Serif</div>
                        <div class="font-option" data-font="mono">Monospace</div>
                        <div class="font-option" data-font="rounded">Rounded</div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>AI Behavior</h3>
                    
                    <div class="settings-section">
                        <h3>Advanced AI Settings</h3>
                        
                        <div class="toggle-option">
                            <div>
                                <span class="toggle-label">Learning Mode</span>
                                <p class="toggle-description">Allow Nexus to learn from our conversations to better assist you</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="learningToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-option">
                            <div>
                                <span class="toggle-label">Context Awareness</span>
                                <p class="toggle-description">Maintain conversation context for more natural interactions</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="contextToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="range-option">
                            <div class="range-header">
                                <span class="range-label">Creativity Level</span>
                                <span class="range-value" id="creativityValue">Balanced</span>
                            </div>
                            <input type="range" min="1" max="5" value="3" class="range-slider" id="creativityRange">
                        </div>
                    </div>
                    
                    <div class="option-group">
                        <label class="radio-option">
                            <input type="radio" name="responseStyle" value="balanced" checked>
                            <div class="radio-design">
                                <div class="radio-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                                    </svg>
                                </div>
                                <div class="radio-label">Balanced</div>
                            </div>
                        </label>
                        
                        <label class="radio-option">
                            <input type="radio" name="responseStyle" value="creative">
                            <div class="radio-design">
                                <div class="radio-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                    </svg>
                                </div>
                                <div class="radio-label">Creative</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="option-group">
                        <label class="radio-option">
                            <input type="radio" name="responseStyle" value="precise">
                            <div class="radio-design">
                                <div class="radio-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                    </svg>
                                </div>
                                <div class="radio-label">Precise</div>
                            </div>
                        </label>
                        
                        <label class="radio-option">
                            <input type="radio" name="responseStyle" value="casual">
                            <div class="radio-design">
                                <div class="radio-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                </div>
                                <div class="radio-label">Casual</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="range-option">
                        <div class="range-header">
                            <span class="range-label">Response Length</span>
                            <span class="range-value" id="responseLengthValue">Medium</span>
                        </div>
                        <input type="range" min="1" max="5" value="3" class="range-slider" id="responseLengthRange">
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <button class="sidebar-button cancel-button" id="cancelSettings">Cancel</button>
                <button class="sidebar-button save-button" id="saveSettings">Save Changes</button>
            </div>
        </div>

        <!-- Voice Input Overlay -->
        <div class="voice-input-overlay" id="voiceInputOverlay">
            <div class="voice-input-container">
                <button class="voice-close-button" id="voiceCloseButton">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="voice-icon">
                    <div class="voice-pulse" id="voicePulse"></div>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </div>
                <h3 class="voice-title">Speak Now</h3>
                
                <!-- Voice flow visualization -->
                <div class="voice-visualization">
                    <div class="voice-flow" id="voiceFlow"></div>
                    <div class="voice-wave" id="voiceWave">
                        <!-- Voice bars will be added dynamically -->
                    </div>
                </div>
                
                <div class="voice-transcript" id="voiceTranscript">Listening...</div>
                <div class="voice-controls">
                    <button class="voice-button voice-cancel" id="voiceCancelButton">Cancel</button>
                    <button class="voice-button voice-send" id="voiceSendButton">Send Message</button>
                </div>
            </div>
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const chatContainer = document.getElementById('chatContainer');
            const welcomeScreen = document.getElementById('welcomeScreen');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const voiceButton = document.getElementById('voiceButton');
            const attachButton = document.getElementById('attachButton');
            const typingIndicator = document.getElementById('typingIndicator');
            const emojiButton = document.getElementById('emojiButton');
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiSuggestions = document.getElementById('emojiSuggestions');
            const emojis = document.querySelectorAll('.emoji');
            const emojiTabs = document.querySelectorAll('.emoji-tab');
            const glowContainer = document.querySelector('.glow-container');
            const settingsButton = document.getElementById('settingsButton');
            const settingsSidebar = document.getElementById('settingsSidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebarClose = document.getElementById('sidebarClose');
            const cancelSettings = document.getElementById('cancelSettings');
            const saveSettings = document.getElementById('saveSettings');
            const themeOptions = document.querySelectorAll('.theme-option');
            const fontOptions = document.querySelectorAll('.font-option');
            const fontSizeRange = document.getElementById('fontSizeRange');
            const fontSizeValue = document.getElementById('fontSizeValue');
            const responseLengthRange = document.getElementById('responseLengthRange');
            const responseLengthValue = document.getElementById('responseLengthValue');
            const creativityRange = document.getElementById('creativityRange');
            const creativityValue = document.getElementById('creativityValue');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const soundToggle = document.getElementById('soundToggle');
            const typingAnimToggle = document.getElementById('typingAnimToggle');
            const autoScrollToggle = document.getElementById('autoScrollToggle');
            const learningToggle = document.getElementById('learningToggle');
            const contextToggle = document.getElementById('contextToggle');
            const voiceInputOverlay = document.getElementById('voiceInputOverlay');
            const voiceCloseButton = document.getElementById('voiceCloseButton');
            const voiceCancelButton = document.getElementById('voiceCancelButton');
            const voiceSendButton = document.getElementById('voiceSendButton');
            const voiceTranscript = document.getElementById('voiceTranscript');
            const voicePulse = document.getElementById('voicePulse');
            const voiceFlow = document.getElementById('voiceFlow');
            const voiceWave = document.getElementById('voiceWave');
            const logoAnimContainer = document.getElementById('logoAnimContainer');
            const logoAnimation = document.getElementById('logoAnimation');
            const headerLogo = document.getElementById('headerLogo');
            const avatar = document.querySelector('.avatar');

            // Hide the default avatar initially
if (avatar) {
    avatar.style.display = 'none';
}

// Animation timeline
setTimeout(() => {
    // Step 1: Add move-to-corner class to start moving the logo
    if (logoAnimation) logoAnimation.classList.add('move-to-corner');
    
    // Step 2: Fade out animation container
    setTimeout(() => {
        if (logoAnimContainer) logoAnimContainer.classList.add('fade-out');
        
        // Step 3: Show the header logo
        if (headerLogo) headerLogo.classList.add('visible');
        
        // Step 4: Remove animation container after transition completes
        setTimeout(() => {
            if (logoAnimContainer) logoAnimContainer.remove();
            
            // Make sure the layout is properly restored
            document.body.style.overflow = 'auto';
            
            // Force a repaint to fix any layout issues
            window.dispatchEvent(new Event('resize'));
        }, 800);
        
    }, 1200);
}, 2500);

// Make sure to handle the session check to show animation only once per session
const hasSeenAnimation = sessionStorage.getItem('hasSeenNexusAnimation');

if (hasSeenAnimation) {
    // Skip animation if already seen in this session
    if (logoAnimContainer) logoAnimContainer.remove();
    if (headerLogo) headerLogo.classList.add('visible');
    
    // Set display style directly on all elements to ensure they're properly shown
    document.querySelectorAll('.actions svg, .feature-button').forEach(el => {
        el.style.display = '';
    });
} else {
    // Mark as seen for this session
    sessionStorage.setItem('hasSeenNexusAnimation', 'true');
}


            // Bot responses dictionary
            const botResponses = {
                // Personal questions and small talk
                "hello": "👋 Hello there! How can I assist you today with Nexus AI?",
                "hi": "👋 Hi! I'm Nexus AI, ready to help you. What can I do for you?",
                "hey": "👋 Hey! I'm here to help. What's on your mind today?",
                "good morning": "Good morning! ☀️ Hope you're having a great start to your day. How can I assist you?",
                "good afternoon": "Good afternoon! 🌤️ How can I make your day more productive?",
                "good evening": "Good evening! 🌙 How can I help you tonight?",
                "how are you": "I'm running perfectly, thanks for asking! 🙂 How can I assist you today?",
                "how's it going": "Everything's running smoothly on my end! 🙂 What can I help you with today?",
                "what can you do": "I'm designed to be versatile! 🚀 I can:\n\n• Answer questions about our services\n• Provide technical support\n• Generate creative content\n• Help with account management\n• Offer business insights\n• Schedule meetings\n• And much more!\n\nWhat would you like assistance with?",
                "tell me a joke": "Here's a tech joke for you: 😂\n\nWhy don't programmers like nature?\nIt has too many bugs without a proper debugger!",
                "what's your name": "I'm Nexus AI, your intelligent assistant! 🤖 I'm here to help answer questions, provide information, and assist with various tasks. What can I do for you today?",
                "thanks": "You're welcome! 😊 If you have any other questions later, feel free to ask. I'm always here to help!",
                "thank you": "You're very welcome! 😊 If there's anything else you need assistance with, don't hesitate to reach out. I'm here to help!",
                "goodbye": "Goodbye! 👋 Have a great day, and feel free to come back anytime you need assistance!",
                "bye": "Bye for now! 👋 I'll be here when you need help again!",
                
                // Default response
                "default": "I'm here to help! 🤔 Could you provide more details or rephrase your question? I want to make sure I understand what you're looking for."
            };

            // Emoji keyword mapping for suggestions
            const emojiKeywords = {
                "happy": ["😊", "😁", "😄", "🙂", "😃"],
                "sad": ["😢", "😔", "😞", "😥", "😭"],
                "love": ["❤️", "💖", "💕", "😍", "🥰"],
                "laugh": ["😂", "🤣", "😆", "😅", "😹"],
                "cool": ["😎", "🆒", "👍", "🤙", "🕶️"],
                "think": ["🤔", "🧐", "💭", "🤨", "🙄"],
                "hello": ["👋", "🖐️", "🤚", "✋", "👐"],
                "robot": ["🤖", "🦾", "🦿", "⚙️", "💻"],
                "thanks": ["🙏", "👍", "💯", "❤️", "✨"]
            };

            // Voice recognition variables
            let recognition = null;
            let recognitionActive = false;
            let transcriptText = '';
            let voiceBarIntervals = [];

            // Find response based on keywords
            function findResponse(message) {
                message = message.toLowerCase().trim();
                
                // Check for exact matches first
                if (botResponses[message]) {
                    return botResponses[message];
                }
                
                // Check for partial matches
                for (const key in botResponses) {
                    if (message.includes(key)) {
                        return botResponses[key];
                    }
                }
                
                // Default response
                return botResponses["default"];
            }

            // Add message to chat
            function addMessage(content, isUser = false) {
                // Hide welcome screen if visible
                if (welcomeScreen.style.display !== 'none') {
                    welcomeScreen.style.display = 'none';
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');
                messageDiv.classList.add(isUser ? 'user' : 'bot');
                
                // Add avatar based on message type
                if (!isUser) {
                    const avatar = document.createElement('div');
                    avatar.classList.add('message-avatar');
                    avatar.textContent = 'N';
                    messageDiv.appendChild(avatar);
                } else {
                    const avatar = document.createElement('div');
                    avatar.classList.add('user-avatar');
                    avatar.textContent = 'Y';
                    messageDiv.appendChild(avatar);
                }
                
                const messageContent = document.createElement('div');
                messageContent.classList.add('message-content');
                
                if (!isUser && typingAnimToggle.checked) {
                    const typingContent = document.createElement('div');
                    typingContent.classList.add('typing-animation');
                    typingContent.innerHTML = content;
                    messageContent.appendChild(typingContent);
                    
                    // Start animation after a short delay
                    setTimeout(() => {
                        typingContent.classList.add('animate');
                    }, 100);
                } else {
                    messageContent.innerHTML = content;
                }
                
                const messageTime = document.createElement('div');
                messageTime.classList.add('message-time');
                const now = new Date();
                messageTime.textContent = now.getHours().toString().padStart(2, '0') + ':' + 
                                        now.getMinutes().toString().padStart(2, '0');
                
                // Add message actions for bot messages
                if (!isUser) {
                    const messageActions = document.createElement('div');
                    messageActions.classList.add('message-actions');
                    
                    // Copy button
                    const copyButton = document.createElement('button');
                    copyButton.classList.add('message-action-button');
                    copyButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    `;
                    
                    // Add thumbs up button
                    const thumbsUpButton = document.createElement('button');
                    thumbsUpButton.classList.add('message-action-button');
                    thumbsUpButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905a3.61 3.61 0 01-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                        </svg>
                    `;
                    
                    // Add event listeners to buttons
                    copyButton.addEventListener('click', () => {
                        copyMessage(messageContent.innerText || messageContent.textContent);
                    });
                    
                    messageActions.appendChild(copyButton);
                    messageActions.appendChild(thumbsUpButton);
                    
                    messageDiv.appendChild(messageActions);
                }
                
                messageDiv.appendChild(messageContent);
                messageDiv.appendChild(messageTime);
                
                // Insert into chat container
                chatContainer.appendChild(messageDiv);
                
                // Show typing indicator right after user messages
                if (isUser && typingAnimToggle.checked) {
                    const typingDiv = document.createElement('div');
                    typingDiv.id = 'currentTypingIndicator';
                    typingDiv.classList.add('typing-indicator');
                    
                    const dot1 = document.createElement('div');
                    const dot2 = document.createElement('div');
                    const dot3 = document.createElement('div');
                    dot1.classList.add('typing-dot');
                    dot2.classList.add('typing-dot');
                    dot3.classList.add('typing-dot');
                    
                    typingDiv.appendChild(dot1);
                    typingDiv.appendChild(dot2);
                    typingDiv.appendChild(dot3);
                    
                    chatContainer.appendChild(typingDiv);
                    
                    // Show typing indicator
                    setTimeout(() => {
                        typingDiv.classList.add('active');
                    }, 100);
                }
                
                // Scroll to bottom
                if (autoScrollToggle.checked) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                
                return messageDiv;
            }

            // Hide typing indicator
            function hideTypingIndicator() {
                const currentIndicator = document.getElementById('currentTypingIndicator');
                if (currentIndicator) {
                    currentIndicator.classList.remove('active');
                    setTimeout(() => {
                        currentIndicator.remove();
                    }, 300);
                }
            }

// Replace the existing processUserMessage function
function processUserMessage() {
    const message = userInput.value.trim();
    if (message === '') return;
    
    // Add user message
    addMessage(message, true);
    
    // Clear input
    userInput.value = '';
    
    // Adjust height
    adjustTextareaHeight();
    
    // Hide emoji picker and suggestions if open
    emojiPicker.classList.remove('active');
    emojiSuggestions.classList.remove('active');
    
    // Play sound
    if (soundToggle.checked) {
        playMessageSound(true);
    }
    
    // Wait and respond (simulating bot thinking)
    setTimeout(() => {
        // Hide typing indicator
        hideTypingIndicator();
        
        // Get and add bot response
        const response = findResponse(message);
        addMessage(response);
        
        // Play sound
        if (soundToggle.checked) {
            playMessageSound(false);
        }
        
        // Add subtle animation to the glow
        animateGlow();
        
        // Mark conversation as started and save it
        if (!window.conversationStarted) {
            window.conversationStarted = true;
            
            // Add session indicator to the chat
            addSessionIndicator();
            
            // Save the conversation after the first exchange
            saveConversationToHistory();
        }
    }, 1500 + Math.random() * 1000);
}

            // Copy message to clipboard
            function copyMessage(content) {
                // Strip HTML tags for plain text
                const tempElement = document.createElement('div');
                tempElement.innerHTML = content;
                const textContent = tempElement.textContent;
                
                navigator.clipboard.writeText(textContent).then(() => {
                    // Show copy notification
                    const notification = document.createElement('div');
                    notification.style.position = 'fixed';
                    notification.style.bottom = '20px';
                    notification.style.left = '50%';
                    notification.style.transform = 'translateX(-50%)';
                    notification.style.padding = '10px 20px';
                    notification.style.background = 'rgba(0, 0, 0, 0.7)';
                    notification.style.color = 'white';
                    notification.style.borderRadius = '4px';
                    notification.style.zIndex = '9999';
                    notification.textContent = 'Copied to clipboard';
                    
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 2000);
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    alert('Failed to copy to clipboard');
                });
            }

            // Initialize the voice wave visualization
            function initVoiceWave() {
                if (!voiceWave) return;
                
                voiceWave.innerHTML = '';
                
                // Create 20 bars for the wave visualization
                for (let i = 0; i < 20; i++) {
                    const bar = document.createElement('div');
                    bar.classList.add('voice-bar');
                    voiceWave.appendChild(bar);
                }
            }

            // Animate the voice wave
            function animateVoiceWave(isActive) {
                const bars = document.querySelectorAll('.voice-bar');
                
                // Clear any existing animation intervals
                voiceBarIntervals.forEach(interval => clearInterval(interval));
                voiceBarIntervals = [];
                
                if (isActive) {
                    // Start animation for voice wave
                    bars.forEach(bar => {
                        const interval = setInterval(() => {
                            const height = Math.floor(Math.random() * 30) + 10;
                            bar.style.height = `${height}px`;
                        }, 200 + Math.random() * 200);
                        
                        voiceBarIntervals.push(interval);
                    });
                    
                    // Animate voice flow
                    if (voiceFlow) {
                        voiceFlow.classList.add('animate');
                    }
                } else {
                    // Stop animations
                    bars.forEach(bar => {
                        bar.style.height = '20px';
                    });
                    
                    if (voiceFlow) {
                        voiceFlow.classList.remove('animate');
                    }
                }
            }

            // Start voice recognition
            function startVoiceRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    // Create a new recognition instance
                    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.lang = 'en-US';
                    
                    recognition.onstart = function() {
                        recognitionActive = true;
                        if (voicePulse) {
                            voicePulse.classList.add('animate');
                        }
                    };
                    
                    recognition.onresult = function(event) {
                        let interimTranscript = '';
                        let finalTranscript = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                finalTranscript += event.results[i][0].transcript;
                            } else {
                                interimTranscript += event.results[i][0].transcript;
                            }
                        }
                        
                        transcriptText = finalTranscript || interimTranscript;
                        if (voiceTranscript) {
                            voiceTranscript.textContent = transcriptText || 'Listening...';
                        }
                        
                        // Update visualizations based on speech volume
                        const volume = Array.from(event.results)
                            .some(result => result.isFinal) ? 0.8 : 0.4;
                            
                        // Adjust voice visualization based on volume
                        const bars = document.querySelectorAll('.voice-bar');
                        bars.forEach(bar => {
                            const height = Math.floor(Math.random() * 30 * volume) + 10;
                            bar.style.height = `${height}px`;
                        });
                    };
                    
                    recognition.onerror = function(event) {
                        console.error('Speech recognition error:', event.error);
                        if (voiceTranscript) {
                            voiceTranscript.textContent = 'Error: ' + event.error;
                        }
                    };
                    
                    recognition.onend = function() {
                        recognitionActive = false;
                        if (voicePulse) {
                            voicePulse.classList.remove('animate');
                        }
                        
                        // Restart recognition if it wasn't manually stopped
                        if (voiceInputOverlay && voiceInputOverlay.classList.contains('active') && transcriptText.length === 0) {
                            startVoiceRecognition();
                        }
                    };
                    
                    try {
                        recognition.start();
                    } catch (error) {
                        console.error('Speech recognition start error:', error);
                        if (voiceTranscript) {
                            voiceTranscript.textContent = 'Could not start speech recognition';
                        }
                    }
                } else {
                    if (voiceTranscript) {
                        voiceTranscript.textContent = 'Speech recognition not supported in this browser';
                    }
                    console.error('Speech recognition not supported');
                }
            }

            // Stop voice recognition
            function stopVoiceRecognition() {
                if (recognition && recognitionActive) {
                    recognition.stop();
                    recognitionActive = false;
                }
            }

            // Open voice input interface
            function openVoiceInput() {
                if (voiceInputOverlay) {
                    voiceInputOverlay.classList.add('active');
                }
                
                if (voicePulse) {
                    voicePulse.classList.add('animate');
                }
                
                if (voiceTranscript) {
                    voiceTranscript.textContent = 'Listening...';
                }
                
                // Initialize and animate the voice visualizations
                initVoiceWave();
                setTimeout(() => {
                    animateVoiceWave(true);
                }, 300);
                
                // Clear any previous transcript
                transcriptText = '';
                
                // Start voice recognition
                startVoiceRecognition();
            }

            // Close voice input interface
            function closeVoiceInput() {
                if (voiceInputOverlay) {
                    voiceInputOverlay.classList.remove('active');
                }
                
                if (voicePulse) {
                    voicePulse.classList.remove('animate');
                }
                
                animateVoiceWave(false);
                
                // Stop voice recognition if active
                stopVoiceRecognition();
            }

            // Process voice message
            function processVoiceMessage(message) {
                if (!message || message.trim() === '') return;
                
                // Close voice overlay
                closeVoiceInput();
                
                // Add user message
                addMessage(message, true);
                
                // Play sound
                if (soundToggle.checked) {
                    playMessageSound(true);
                }
                
                // Wait and respond (simulating bot thinking)
                setTimeout(() => {
                    // Hide typing indicator
                    hideTypingIndicator();
                    
                    // Get and add bot response
                    const response = findResponse(message);
                    addMessage(response);
                    
                    // Play sound
                    if (soundToggle.checked) {
                        playMessageSound(false);
                    }
                    
                    // Add subtle animation to the glow
                    animateGlow();
                }, 1500 + Math.random() * 1000);
            }

            // Play message sound (stub function)
            function playMessageSound(isUser) {
                // In a real app, you would play different sounds here
                console.log(`Play ${isUser ? 'user' : 'bot'} message sound`);
            }

            // Adjust textarea height
            function adjustTextareaHeight() {
                userInput.style.height = 'auto';
                userInput.style.height = (userInput.scrollHeight > 150 ? 150 : userInput.scrollHeight) + 'px';
            }

            // Animate the glow effect
            function animateGlow() {
                glowContainer.style.left = Math.random() * 300 + 'px';
                glowContainer.style.top = Math.random() * 400 + 'px';
                glowContainer.style.opacity = '1';
                
                setTimeout(() => {
                    glowContainer.style.opacity = '0';
                }, 2000);
            }

            // Toggle emoji picker
            function toggleEmojiPicker() {
                emojiPicker.classList.toggle('active');
                settingsSidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                emojiSuggestions.classList.remove('active');
            }

            // Toggle settings sidebar
            function toggleSettingsSidebar() {
                settingsSidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
                emojiPicker.classList.remove('active');
                emojiSuggestions.classList.remove('active');
            }

            // Add emoji to input
            function addEmojiToInput(emoji) {
                userInput.value += emoji;
                userInput.focus();
                adjustTextareaHeight();
            }

            // Check for emoji suggestions based on input
            function checkEmojiSuggestions(inputText) {
                // Clear previous suggestions
                emojiSuggestions.innerHTML = '';
                
                // Split input into words and check last word
                const words = inputText.toLowerCase().split(/\s+/);
                if (words.length === 0) return false;
                
                const lastWord = words[words.length - 1].replace(/[^a-z0-9]/gi, '');
                if (lastWord.length < 2) return false;
                
                let foundSuggestions = false;
                
                // Check for keyword matches
                for (const [keyword, emojis] of Object.entries(emojiKeywords)) {
                    if (keyword.includes(lastWord) || lastWord.includes(keyword)) {
                        foundSuggestions = true;

                        // Add each matching emoji to the suggestions
                        emojis.forEach(emoji => {
                            const emojiElement = document.createElement('div');
                            emojiElement.classList.add('emoji-suggestion');
                            emojiElement.textContent = emoji;
                            emojiElement.addEventListener('click', () => {
                                // Remove the last word and add emoji
                                const textBeforeLastWord = inputText.substring(0, inputText.lastIndexOf(lastWord));
                                userInput.value = textBeforeLastWord + emoji + ' ';
                                userInput.focus();
                                emojiSuggestions.classList.remove('active');
                            });
                            
                            emojiSuggestions.appendChild(emojiElement);
                        });
                    }
                }
                
                // Show/hide suggestions container
                if (foundSuggestions) {
                    emojiSuggestions.classList.add('active');
                } else {
                    emojiSuggestions.classList.remove('active');
                }
                
                return foundSuggestions;
            }

            // Change theme and adapt text colors for readability
            function changeTheme(theme) {
                const root = document.documentElement;
                
                // Remove active class from all options
                themeOptions.forEach(option => option.classList.remove('active'));
                
                // Add active class to selected theme
                let selectedTheme = document.querySelector(`.theme-${theme}`);
                if (selectedTheme) {
                    selectedTheme.classList.add('active');
                }
                
                // Set theme variables
                switch(theme) {
                    case 'blue':
                        root.style.setProperty('--primary', '#0EA5E9');
                        root.style.setProperty('--primary-light', '#38BDF8');
                        root.style.setProperty('--primary-dark', '#0284C7');
                        break;
                    case 'green':
                        root.style.setProperty('--primary', '#10B981');
                        root.style.setProperty('--primary-light', '#34D399');
                        root.style.setProperty('--primary-dark', '#059669');
                        break;
                    case 'rose':
                        root.style.setProperty('--primary', '#F43F5E');
                        root.style.setProperty('--primary-light', '#FB7185');
                        root.style.setProperty('--primary-dark', '#E11D48');
                        break;
                    case 'amber':
                        root.style.setProperty('--primary', '#F59E0B');
                        root.style.setProperty('--primary-light', '#FBBF24');
                        root.style.setProperty('--primary-dark', '#D97706');
                        break;
                    case 'violet':
                        root.style.setProperty('--primary', '#8B5CF6');
                        root.style.setProperty('--primary-light', '#A78BFA');
                        root.style.setProperty('--primary-dark', '#7C3AED');
                        break;
                    case 'cyan':
                        root.style.setProperty('--primary', '#06B6D4');
                        root.style.setProperty('--primary-light', '#22D3EE');
                        root.style.setProperty('--primary-dark', '#0891B2');
                        break;
                    case 'emerald':
                        root.style.setProperty('--primary', '#059669');
                        root.style.setProperty('--primary-light', '#10B981');
                        root.style.setProperty('--primary-dark', '#047857');
                        break;
                    default: // Purple
                        root.style.setProperty('--primary', '#5046E5');
                        root.style.setProperty('--primary-light', '#6366F1');
                        root.style.setProperty('--primary-dark', '#4338CA');
                }
                
                // Update message styling to match theme
                updateMessagesWithTheme();
            }

            // Update existing messages with new theme colors
            function updateMessagesWithTheme() {
                const userMessages = document.querySelectorAll('.message.user .message-content');
                const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
                const primaryLight = getComputedStyle(document.documentElement).getPropertyValue('--primary-light').trim();
                
                userMessages.forEach(message => {
                    message.style.background = `linear-gradient(135deg, ${primary} 0%, ${primaryLight} 100%)`;
                });
                
                // Update any other theme-dependent elements
                const messageAvatars = document.querySelectorAll('.message-avatar');
                messageAvatars.forEach(avatar => {
                    avatar.style.backgroundColor = primaryLight;
                });
            }

            // Change font
            function changeFont(fontFamily) {
                // Remove active class from all options
                fontOptions.forEach(option => option.classList.remove('active'));
                
                // Add active class to selected font
                let selectedFont = document.querySelector(`.font-option[data-font="${fontFamily}"]`);
                if (selectedFont) {
                    selectedFont.classList.add('active');
                }
                
                // Apply font family
                let fontValue = '';
                switch(fontFamily) {
                    case 'serif':
                        fontValue = 'Georgia, serif';
                        break;
                    case 'mono':
                        fontValue = 'Consolas, monospace';
                        break;
                    case 'rounded':
                        fontValue = 'Quicksand, Comfortaa, system-ui, sans-serif';
                        break;
                    default: // system
                        fontValue = 'Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                }
                
                document.body.style.fontFamily = fontValue;
            }

            // Toggle dark mode
            function toggleDarkMode() {
                const root = document.documentElement;
                const isDarkMode = darkModeToggle.checked;
                
                if (isDarkMode) {
                    root.style.setProperty('--text', '#F9FAFB');
                    root.style.setProperty('--text-light', '#E5E7EB');
                    root.style.setProperty('--white', '#1F2937');
                    root.style.setProperty('--secondary', '#374151');
                    document.body.style.background = 'linear-gradient(135deg, #111827 0%, #1F2937 100%)';
                    chatContainer.style.backgroundColor = '#111827';
                    
                    // Update any other dark mode specific styles for better contrast
                    const botMessages = document.querySelectorAll('.message.bot .message-content');
                    botMessages.forEach(message => {
                        message.style.color = '#F9FAFB';
                    });
                    
                    // Update buttons and UI elements for better visibility in dark mode
                    document.querySelectorAll('.feature-button').forEach(button => {
                        button.style.backgroundColor = '#374151';
                        button.style.color = '#E5E7EB';
                    });
                } else {
                    root.style.setProperty('--text', '#1F2937');
                    root.style.setProperty('--text-light', '#6B7280');
                    root.style.setProperty('--white', '#FFFFFF');
                    root.style.setProperty('--secondary', '#F9FAFB');
                    document.body.style.background = 'linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%)';
                    chatContainer.style.backgroundColor = '#FCFCFC';
                    
                    // Restore original styling
                    const botMessages = document.querySelectorAll('.message.bot .message-content');
                    botMessages.forEach(message => {
                        message.style.color = '#1F2937';
                    });
                    
                    document.querySelectorAll('.feature-button').forEach(button => {
                        button.style.backgroundColor = '#F9FAFB';
                        button.style.color = '#6B7280';
                    });
                }
            }

            // Update font size value display
            function updateFontSizeValue() {
                const value = fontSizeRange.value;
                const sizes = ['Extra Small', 'Small', 'Medium', 'Large', 'Extra Large'];
                fontSizeValue.textContent = sizes[value - 1];
                
                // Apply font size
                const fontSizes = ['12px', '14px', '15px', '16px', '18px'];
                document.body.style.fontSize = fontSizes[value - 1];
            }

            // Update response length value display
            function updateResponseLengthValue() {
                const value = responseLengthRange.value;
                const lengths = ['Very Short', 'Short', 'Medium', 'Long', 'Very Long'];
                responseLengthValue.textContent = lengths[value - 1];
            }

            // Update creativity value display
            function updateCreativityValue() {
                if (creativityRange && creativityValue) {
                    const value = creativityRange.value;
                    const levels = ['Precise', 'Conservative', 'Balanced', 'Creative', 'Highly Creative'];
                    creativityValue.textContent = levels[value - 1];
                }
            }

            // Add conversation history feature with improved modal
function addConversationHistory() {
    // Create history modal with enhanced styling
    const historyModal = document.createElement('div');
    historyModal.id = 'historyModal';
    historyModal.classList.add('history-modal');
    historyModal.innerHTML = `
        <div class="history-modal-content">
            <div class="history-modal-header">
                <h2>Conversation History</h2>
                <button id="closeHistoryModal">×</button>
            </div>
            <div id="historyContent" class="history-content">
                <!-- Conversation history will be dynamically populated here -->
            </div>
            <div class="history-modal-footer">
                <button id="clearHistoryButton">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin-right: 6px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Clear All History
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(historyModal);

    // Add history button to header
    const headerActions = document.querySelector('.actions');
    const historyButton = document.createElement('svg');
    historyButton.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    historyButton.setAttribute('fill', 'none');
    historyButton.setAttribute('viewBox', '0 0 24 24');
    historyButton.setAttribute('stroke', 'currentColor');
    historyButton.id = 'historyButton';
    historyButton.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
    `;
    headerActions.appendChild(historyButton);

    // Event Listeners for history
    historyButton.addEventListener('click', () => {
        document.getElementById('historyModal').style.display = 'block';
        updateHistoryDisplay();
    });

    document.getElementById('closeHistoryModal').addEventListener('click', () => {
        document.getElementById('historyModal').style.display = 'none';
    });

    document.getElementById('clearHistoryButton').addEventListener('click', () => {
        // Create confirmation dialog for clearing all history
        const confirmDialog = document.createElement('div');
        confirmDialog.classList.add('confirmation-dialog');
        
        confirmDialog.innerHTML = `
            <div class="confirmation-dialog-content">
                <h3 class="confirmation-title">Clear All History</h3>
                <p class="confirmation-message">Are you sure you want to delete all conversation history? This action cannot be undone.</p>
                <div class="confirmation-actions">
                    <button class="confirmation-cancel">Cancel</button>
                    <button class="confirmation-confirm">Clear All</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(confirmDialog);
        
        // Add event listeners
        const cancelButton = confirmDialog.querySelector('.confirmation-cancel');
        const confirmButton = confirmDialog.querySelector('.confirmation-confirm');
        
        cancelButton.addEventListener('click', () => {
            confirmDialog.remove();
        });
        
        confirmButton.addEventListener('click', () => {
            localStorage.removeItem('nexusConversationHistory');
            updateHistoryDisplay();
            confirmDialog.remove();
        });
    });
}

            // Add Options Menu button and dropdown to the header
function addOptionsMenu() {
    const header = document.querySelector('.header');
    
    // Create options button container for center positioning
    const optionsContainer = document.createElement('div');
    optionsContainer.classList.add('options-container');
    
    // Create options button
    const optionsButton = document.createElement('button');
    optionsButton.classList.add('options-button');
    optionsButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
        <span>Options</span>
    `;
    
    // Create dropdown menu
    const dropdownMenu = document.createElement('div');
    dropdownMenu.classList.add('options-dropdown');
    dropdownMenu.innerHTML = `
        <button class="dropdown-option new-chat-option">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            <span>New Chat</span>
        </button>
        <button class="dropdown-option history-option">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>History</span>
        </button>
    `;
    
    // Add elements to DOM
    optionsContainer.appendChild(optionsButton);
    optionsContainer.appendChild(dropdownMenu);
    header.appendChild(optionsContainer);
    
    // Add event listeners
    optionsButton.addEventListener('click', toggleOptionsMenu);
    
    // Event listeners for dropdown options
    const newChatOption = dropdownMenu.querySelector('.new-chat-option');
    const historyOption = dropdownMenu.querySelector('.history-option');
    
    newChatOption.addEventListener('click', () => {
        toggleOptionsMenu();
        startNewChatWithGreeting();
    });
    
    historyOption.addEventListener('click', () => {
        toggleOptionsMenu();
        openHistoryModal();
    });
    
    // Click outside to close
    document.addEventListener('click', (event) => {
        if (!optionsContainer.contains(event.target) && 
            dropdownMenu.classList.contains('active')) {
            toggleOptionsMenu();
        }
    });
}

// Toggle options dropdown menu
function toggleOptionsMenu() {
    const dropdown = document.querySelector('.options-dropdown');
    dropdown.classList.toggle('active');
    
    // Add subtle animation to dropdown items when opening
    if (dropdown.classList.contains('active')) {
        const options = dropdown.querySelectorAll('.dropdown-option');
        options.forEach((option, index) => {
            option.style.opacity = '0';
            option.style.transform = 'translateY(-10px)';
            
            setTimeout(() => {
                option.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                option.style.opacity = '1';
                option.style.transform = 'translateY(0)';
            }, 50 + (index * 50));
        });
    }
}

// Open history modal with animation
function openHistoryModal() {
    const historyModal = document.getElementById('historyModal');
    
    if (historyModal) {
        // Fade in the modal
        historyModal.style.display = 'block';
        historyModal.style.opacity = '0';
        
        setTimeout(() => {
            historyModal.style.transition = 'opacity 0.3s ease';
            historyModal.style.opacity = '1';
            
            // Slide in the content
            const content = historyModal.querySelector('.history-modal-content');
            if (content) {
                content.style.transform = 'translateY(20px)';
                content.style.opacity = '0';
                
                setTimeout(() => {
                    content.style.transition = 'transform 0.4s ease, opacity 0.4s ease';
                    content.style.transform = 'translateY(0)';
                    content.style.opacity = '1';
                }, 100);
            }
        }, 50);
        
        // Update the history display
        updateHistoryDisplay();
    }
}

// Add this function to create a session indicator
function addSessionIndicator() {
    const sessionIndicator = document.createElement('div');
    sessionIndicator.classList.add('chat-session-indicator');
    
    const now = new Date();
    const formattedDate = now.toLocaleString(undefined, {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    sessionIndicator.textContent = `New conversation started ${formattedDate}`;
    
    // Insert at the top of the chat
    chatContainer.insertBefore(sessionIndicator, chatContainer.firstChild);
    
    // Add subtle animation
    sessionIndicator.style.opacity = '0';
    sessionIndicator.style.transform = 'translateY(-10px)';
    
    setTimeout(() => {
        sessionIndicator.style.transition = 'all 0.5s ease';
        sessionIndicator.style.opacity = '1';
        sessionIndicator.style.transform = 'translateY(0)';
    }, 300);
}

// Enhanced startNewChatWithGreeting function
function startNewChatWithGreeting() {
    // Save current conversation first
    if (window.conversationStarted) {
        saveConversationToHistory();
    }
    
    // Reset conversation started flag
    window.conversationStarted = false;
    
    // Get all existing messages
    const messages = document.querySelectorAll('.message, .chat-session-indicator');
    
    if (messages.length === 0) {
        // If no messages, just show the welcome message
        showNewChatGreeting();
        return;
    }
    
    // Apply staggered fade-out animation to each message
    messages.forEach((message, index) => {
        setTimeout(() => {
            message.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            message.style.opacity = '0';
            message.style.transform = 'translateY(-10px)';
        }, index * 50);
    });
    
    // Wait for animation to complete, then clear and show welcome
    setTimeout(() => {
        // Clear the chat container
        document.getElementById('chatContainer').innerHTML = '';
        
        // Show new chat greeting
        showNewChatGreeting();
    }, (messages.length * 50) + 300);
}

// Show the specific new chat greeting
function showNewChatGreeting() {
    // Add welcome message with fade-in animation
    const welcomeMessage = addMessage("👋 Looks like you have started a new chat. How can I help?");
    
    // Apply fade-in animation
    welcomeMessage.style.opacity = '0';
    welcomeMessage.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
        welcomeMessage.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        welcomeMessage.style.opacity = '1';
        welcomeMessage.style.transform = 'translateY(0)';
    }, 100);
}

// Add styles for the options menu
function addOptionsMenuStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .options-container {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 16px;
            z-index: 15;
        }
        
        .options-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .options-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .options-button svg {
            width: 16px;
            height: 16px;
            transition: transform 0.3s ease;
        }
        
        .options-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            width: 180px;
            margin-top: 8px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 6px;
            z-index: 20;
            overflow: hidden;
        }
        
        .options-dropdown.active {
            display: flex;
            animation: slideDown 0.3s ease forwards;
        }
        
        .dropdown-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            font-weight: 500;
        }
        
        .dropdown-option svg {
            width: 18px;
            height: 18px;
            color: var(--primary);
        }
        
        .dropdown-option:hover {
            background: var(--secondary);
        }
        
        .dropdown-option.new-chat-option:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .dropdown-option.history-option:hover {
            background: rgba(79, 70, 229, 0.1);
        }
        
        /* Dark mode compatibility */
        .options-dropdown {
            background: var(--white);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* For history modal animation */
        .history-modal {
            transition: opacity 0.3s ease;
        }
        
        .history-modal-content {
            transition: transform 0.4s ease, opacity 0.4s ease;
        }
    `;
    
    document.head.appendChild(style);
}

            // 3. Update the updateHistoryDisplay function to show titles
function updateHistoryDisplay() {
    const historyContent = document.getElementById('historyContent');
    if (!historyContent) return;
    
    try {
        const history = JSON.parse(localStorage.getItem('nexusConversationHistory')) || [];
        
        if (history.length === 0) {
            historyContent.innerHTML = `
                <div class="empty-history">
                    <p>No conversation history yet.</p>
                    <p>Start chatting to save your conversations!</p>
                </div>
            `;
            return;
        }
        
        let historyHTML = '';
        
        history.reverse().forEach((session, index) => {
            const date = new Date(session.timestamp);
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Get first message snippet
            let snippet = 'No messages';
            if (session.messages && session.messages.length > 0) {
                const firstUserMsg = session.messages.find(m => m.isUser);
                if (firstUserMsg) {
                    snippet = firstUserMsg.text.substring(0, 50);
                    if (firstUserMsg.text.length > 50) snippet += '...';
                }
            }
            
            // Include title if available
            const title = session.title ? `<div class="history-session-title">${session.title}</div>` : '';
            
            historyHTML += `
                <div class="history-session" data-index="${index}">
                    <div class="history-session-header">
                        <span class="history-date">${formattedDate}</span>
                        <button class="restore-session">Restore</button>
                    </div>
                    ${title}
                    <div class="history-session-snippet">${snippet}</div>
                </div>
            `;
        });
        
        historyContent.innerHTML = historyHTML;
        
        // Add event listeners to restore session buttons
        document.querySelectorAll('.restore-session').forEach(button => {
            button.addEventListener('click', (e) => {
                const sessionIndex = e.target.closest('.history-session').getAttribute('data-index');
                const history = JSON.parse(localStorage.getItem('nexusConversationHistory')) || [];
                const session = history[history.length - 1 - sessionIndex];
                
                // Clear current chat
                chatContainer.innerHTML = '';
                
                // Restore messages
                session.messages.forEach(msg => {
                    addMessage(msg.text, msg.isUser);
                });
                
                // Close history modal
                document.getElementById('historyModal').style.display = 'none';
            });
        });
    } catch (error) {
        console.error('Error loading conversation history:', error);
        historyContent.innerHTML = `
            <div class="error-history">
                <p>Error loading conversation history.</p>
                <p>Your history might have been corrupted.</p>
            </div>
        `;
    }
}

            // Save conversation to history
            function saveConversationToHistory() {
                const messages = document.querySelectorAll('.message');
                if (messages.length === 0) return;
                
                const history = JSON.parse(localStorage.getItem('nexusConversationHistory') || '[]');
                
                // Create a new session entry
                const session = {
                    timestamp: new Date().toISOString(),
                    messages: Array.from(messages).map(msg => ({
                        text: msg.querySelector('.message-content').innerText,
                        isUser: msg.classList.contains('user'),
                        timestamp: msg.querySelector('.message-time').textContent
                    }))
                };

                // Add to history, limit to last.20 sessions
                history.push(session);
                if (history.length > 20) {
                    history.shift(); // Remove oldest session
                }

                localStorage.setItem('nexusConversationHistory', JSON.stringify(history));
            }

            // EVENT LISTENERS
            
            // User input events
            userInput.addEventListener('input', function() {
                adjustTextareaHeight();
                checkEmojiSuggestions(this.value);
            });

            userInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    processUserMessage();
                }
            });

            // Send button event
            sendButton.addEventListener('click', processUserMessage);

            // Voice button events
            voiceButton.addEventListener('click', openVoiceInput);
            if (voiceCloseButton) {
                voiceCloseButton.addEventListener('click', closeVoiceInput);
            }
            if (voiceCancelButton) {
                voiceCancelButton.addEventListener('click', closeVoiceInput);
            }
            if (voiceSendButton) {
                voiceSendButton.addEventListener('click', () => {
                    if (transcriptText.trim() !== '') {
                        processVoiceMessage(transcriptText);
                    }
                });
            }

            // Emoji button event
            emojiButton.addEventListener('click', toggleEmojiPicker);

            // Emoji selection
            emojis.forEach(emoji => {
                emoji.addEventListener('click', () => {
                    const emojiChar = emoji.getAttribute('data-emoji');
                    addEmojiToInput(emojiChar);
                    emojiPicker.classList.remove('active');
                });
            });

            // Emoji tabs
            emojiTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    emojiTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                });
            });

            // Settings button event
            settingsButton.addEventListener('click', toggleSettingsSidebar);
            sidebarClose.addEventListener('click', toggleSettingsSidebar);
            cancelSettings.addEventListener('click', toggleSettingsSidebar);
            sidebarOverlay.addEventListener('click', toggleSettingsSidebar);

            // Attach button (simulated)
            attachButton.addEventListener('click', () => {
                alert('File attachment feature would open a file picker dialog here.');
            });

            // Theme options
            themeOptions.forEach(option => {
                option.addEventListener('click', (event) => {
                    const theme = event.currentTarget.getAttribute('data-theme');
                    changeTheme(theme);
                });
            });

            // Font options
            fontOptions.forEach(option => {
                option.addEventListener('click', (event) => {
                    const font = event.currentTarget.getAttribute('data-font');
                    changeFont(font);
                });
            });

            // Dark mode toggle
            darkModeToggle.addEventListener('change', toggleDarkMode);

            // Font size range
            fontSizeRange.addEventListener('input', updateFontSizeValue);

            // Response length range
            responseLengthRange.addEventListener('input', updateResponseLengthValue);

            // Creativity range
            if (creativityRange) {
                creativityRange.addEventListener('input', updateCreativityValue);
            }

            // Save settings button
            saveSettings.addEventListener('click', () => {
                // Save preferences to local storage
                localStorage.setItem('nexusSettings', JSON.stringify({
                    darkMode: darkModeToggle.checked,
                    sound: soundToggle.checked,
                    typingAnim: typingAnimToggle.checked,
                    autoScroll: autoScrollToggle.checked,
                    fontSize: fontSizeRange.value,
                    responseLength: responseLengthRange.value,
                    theme: document.querySelector('.theme-option.active').getAttribute('data-theme'),
                    font: document.querySelector('.font-option.active').getAttribute('data-font')
                }));
                
                toggleSettingsSidebar();
            });

            // Document-wide click handler to close emoji picker and suggestions
            document.addEventListener('click', (event) => {
                // Close emoji picker when clicking outside
                if (!emojiPicker.contains(event.target) && 
                    !emojiButton.contains(event.target)) {
                    emojiPicker.classList.remove('active');
                }
                
                // Close emoji suggestions when clicking outside
                if (!emojiSuggestions.contains(event.target) && 
                    !userInput.contains(event.target)) {
                    emojiSuggestions.classList.remove('active');
                }
            });

            // Add New Chat button to header
function addNewChatButton() {
    const headerActions = document.querySelector('.actions');
    
    // Create and add new chat button
    const newChatButton = document.createElement('svg');
    newChatButton.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    newChatButton.setAttribute('fill', 'none');
    newChatButton.setAttribute('viewBox', '0 0 24 24');
    newChatButton.setAttribute('stroke', 'currentColor');
    newChatButton.id = 'newChatButton';
    newChatButton.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
    `;
    newChatButton.title = "New Chat";
    
    // Insert as the first child in actions
    headerActions.insertBefore(newChatButton, headerActions.firstChild);
    
    // Add event listener
    newChatButton.addEventListener('click', startNewChatWithGreeting);
}

// Update the enhanceHistoryFeature function to use the new styling
function enhanceHistoryFeature() {
    // Add session tags/titles to history entries
    const historyContent = document.getElementById('historyContent');
    if (!historyContent) return;
    
    // Modify the updateHistoryDisplay function to support editing session titles
    const originalUpdateHistoryDisplay = updateHistoryDisplay;
    
    updateHistoryDisplay = function() {
        originalUpdateHistoryDisplay();
        
        // Add edit title and delete functionality to each history session
        document.querySelectorAll('.history-session').forEach(session => {
            const headerDiv = session.querySelector('.history-session-header');
            
            // Create actions container
            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('history-actions');
            
            // Add edit title button
            const editButton = document.createElement('button');
            editButton.classList.add('edit-session-title');
            editButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
            `;
            editButton.title = "Edit Title";
            
            // Add delete button
            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-session-button');
            deleteButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            `;
            deleteButton.title = "Delete Conversation";
            
            // Update restore button
            const restoreButton = headerDiv.querySelector('.restore-session');
            restoreButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span>Restore</span>
            `;
            
            // Add buttons to actions div
            actionsDiv.appendChild(editButton);
            actionsDiv.appendChild(deleteButton);
            actionsDiv.appendChild(restoreButton);
            
            // Replace old button with actions div
            headerDiv.innerHTML = '';
            const dateSpan = document.createElement('span');
            dateSpan.classList.add('history-date');
            dateSpan.textContent = session.getAttribute('data-date');
            
            headerDiv.appendChild(dateSpan);
            headerDiv.appendChild(actionsDiv);
            
            // Create content container
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('history-session-content');
            
            // Move title and snippet into content container
            const titleDiv = session.querySelector('.history-session-title');
            const snippetDiv = session.querySelector('.history-session-snippet');
            
            if (titleDiv) {
                titleDiv.classList.add('has-title');
                contentDiv.appendChild(titleDiv);
            }
            
            if (snippetDiv) {
                contentDiv.appendChild(snippetDiv);
            }
            
            session.appendChild(contentDiv);
            
            // Add event listener for edit button
            editButton.addEventListener('click', (e) => {
                e.stopPropagation();
                const sessionIndex = session.getAttribute('data-index');
                const history = JSON.parse(localStorage.getItem('nexusConversationHistory')) || [];
                const sessionData = history[history.length - 1 - sessionIndex];
                
                // Get current title or create one from first message
                const currentTitle = sessionData.title || 
                    (sessionData.messages[0] ? sessionData.messages[0].text.substring(0, 30) + "..." : "Conversation");
                
                // Prompt for new title
                const newTitle = prompt("Enter a name for this conversation:", currentTitle);
                
                if (newTitle && newTitle.trim() !== "") {
                    // Update title in storage
                    sessionData.title = newTitle.trim();
                    localStorage.setItem('nexusConversationHistory', JSON.stringify(history));
                    
                    // Update display
                    updateHistoryDisplay();
                }
            });
            
            // Add event listener for delete button with improved confirmation
            deleteButton.addEventListener('click', (e) => {
                e.stopPropagation();
                const sessionIndex = session.getAttribute('data-index');
                
                // Create confirmation dialog
                showDeleteConfirmation(sessionIndex, session);
            });
            
            // Add event listener for restore
            restoreButton.addEventListener('click', (e) => {
                e.stopPropagation();
                const sessionIndex = session.getAttribute('data-index');
                const history = JSON.parse(localStorage.getItem('nexusConversationHistory')) || [];
                const session = history[history.length - 1 - sessionIndex];
                
                // Clear current chat
                chatContainer.innerHTML = '';
                
                // Restore messages
                session.messages.forEach(msg => {
                    addMessage(msg.text, msg.isUser);
                });
                
                // Close history modal
                document.getElementById('historyModal').style.display = 'none';
            });
        });
    };
}

// Create a better confirmation dialog for deletions
function showDeleteConfirmation(sessionIndex, sessionElement) {
    // Create confirmation dialog
    const confirmDialog = document.createElement('div');
    confirmDialog.classList.add('confirmation-dialog');
    
    confirmDialog.innerHTML = `
        <div class="confirmation-dialog-content">
            <h3 class="confirmation-title">Delete Conversation</h3>
            <p class="confirmation-message">Are you sure you want to delete this conversation? This action cannot be undone.</p>
            <div class="confirmation-actions">
                <button class="confirmation-cancel">Cancel</button>
                <button class="confirmation-confirm">Delete</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(confirmDialog);
    
    // Add event listeners
    const cancelButton = confirmDialog.querySelector('.confirmation-cancel');
    const confirmButton = confirmDialog.querySelector('.confirmation-confirm');
    
    cancelButton.addEventListener('click', () => {
        confirmDialog.remove();
    });
    
    confirmButton.addEventListener('click', () => {
        const history = JSON.parse(localStorage.getItem('nexusConversationHistory')) || [];
        
        // Remove the session from history
        history.splice(history.length - 1 - sessionIndex, 1);
        
        // Save updated history
        localStorage.setItem('nexusConversationHistory', JSON.stringify(history));
        
        // Update display with animation
        sessionElement.style.transition = 'all 0.3s ease';
        sessionElement.style.opacity = '0';
        sessionElement.style.transform = 'translateX(20px)';
        
        setTimeout(() => {
            confirmDialog.remove();
            updateHistoryDisplay();
        }, 300);
    });
}

// Update the updateHistoryDisplay function for better styling
function updateHistoryDisplay() {
    const historyContent = document.getElementById('historyContent');
    if (!historyContent) return;
    
    try {
        const history = JSON.parse(localStorage.getItem('nexusConversationHistory')) || [];
        
        if (history.length === 0) {
            historyContent.innerHTML = `
                <div class="empty-history">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p>No conversation history yet.</p>
                    <p>Start chatting to save your conversations!</p>
                </div>
            `;
            return;
        }
        
        let historyHTML = '';
        
        history.reverse().forEach((session, index) => {
            const date = new Date(session.timestamp);
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Get first message snippet
            let snippet = 'No messages';
            if (session.messages && session.messages.length > 0) {
                const firstUserMsg = session.messages.find(m => m.isUser);
                if (firstUserMsg) {
                    snippet = firstUserMsg.text.substring(0, 50);
                    if (firstUserMsg.text.length > 50) snippet += '...';
                }
            }
            
            // Include title if available
            const title = session.title ? `<div class="history-session-title">${session.title}</div>` : '';
            
            historyHTML += `
                <div class="history-session" data-index="${index}" data-date="${formattedDate}">
                    <div class="history-session-header">
                        <span class="history-date">${formattedDate}</span>
                        <button class="restore-session">Restore</button>
                    </div>
                    ${title}
                    <div class="history-session-snippet">${snippet}</div>
                </div>
            `;
        });
        
        historyContent.innerHTML = historyHTML;
    } catch (error) {
        console.error('Error loading conversation history:', error);
        historyContent.innerHTML = `
            <div class="error-history">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <p>Error loading conversation history.</p>
                <p>Your history might have been corrupted.</p>
            </div>
        `;
    }
}

// Replace the existing initializeCurrentSession function
function initializeCurrentSession() {
    // Create a unique session ID for the current session
    const currentSessionId = 'session-' + Date.now();
    
    // Store the current session ID
    localStorage.setItem('nexusCurrentSessionId', currentSessionId);
    
    // Set a flag to track if a conversation has started
    window.conversationStarted = false;
    
    // Add event listener to save before unload
    window.addEventListener('beforeunload', () => {
        if (window.conversationStarted) {
            saveConversationToHistory();
        }
    });
    
    // We'll remove the interval and save at appropriate times instead
}

// Replace the existing initializeCurrentSession function
function initializeCurrentSession() {
    // Create a unique session ID for the current session
    const currentSessionId = 'session-' + Date.now();
    
    // Store the current session ID
    localStorage.setItem('nexusCurrentSessionId', currentSessionId);
    
    // Set a flag to track if a conversation has started
    window.conversationStarted = false;
    
    // Add event listener to save before unload
    window.addEventListener('beforeunload', () => {
        if (window.conversationStarted) {
            saveConversationToHistory();
        }
    });
    
    // We'll remove the interval and save at appropriate times instead
}

// Replace the existing processUserMessage function
function processUserMessage() {
    const message = userInput.value.trim();
    if (message === '') return;
    
    // Add user message
    addMessage(message, true);
    
    // Clear input
    userInput.value = '';
    
    // Adjust height
    adjustTextareaHeight();
    
    // Hide emoji picker and suggestions if open
    emojiPicker.classList.remove('active');
    emojiSuggestions.classList.remove('active');
    
    // Play sound
    if (soundToggle.checked) {
        playMessageSound(true);
    }
    
    // Wait and respond (simulating bot thinking)
    setTimeout(() => {
        // Hide typing indicator
        hideTypingIndicator();
        
        // Get and add bot response
        const response = findResponse(message);
        addMessage(response);
        
        // Play sound
        if (soundToggle.checked) {
            playMessageSound(false);
        }
        
        // Add subtle animation to the glow
        animateGlow();
        
        // Mark conversation as started and save it
        if (!window.conversationStarted) {
            window.conversationStarted = true;
            
            // Add session indicator to the chat
            addSessionIndicator();
            
            // Save the conversation after the first exchange
            saveConversationToHistory();
        }
    }, 1500 + Math.random() * 1000);
}

// Add this function to create a session indicator
function addSessionIndicator() {
    const sessionIndicator = document.createElement('div');
    sessionIndicator.classList.add('chat-session-indicator');
    
    const now = new Date();
    const formattedDate = now.toLocaleString(undefined, {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    sessionIndicator.textContent = `New conversation started ${formattedDate}`;
    
    // Insert at the top of the chat
    chatContainer.insertBefore(sessionIndicator, chatContainer.firstChild);
    
    // Add subtle animation
    sessionIndicator.style.opacity = '0';
    sessionIndicator.style.transform = 'translateY(-10px)';
    
    setTimeout(() => {
        sessionIndicator.style.transition = 'all 0.5s ease';
        sessionIndicator.style.opacity = '1';
        sessionIndicator.style.transform = 'translateY(0)';
    }, 300);
}

// Enhanced startNewChatWithGreeting function
function startNewChatWithGreeting() {
    // Save current conversation first
    if (window.conversationStarted) {
        saveConversationToHistory();
    }
    
    // Reset conversation started flag
    window.conversationStarted = false;
    
    // Get all existing messages
    const messages = document.querySelectorAll('.message, .chat-session-indicator');
    
    if (messages.length === 0) {
        // If no messages, just show the welcome message
        showNewChatGreeting();
        return;
    }
    
    // Apply staggered fade-out animation to each message
    messages.forEach((message, index) => {
        setTimeout(() => {
            message.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            message.style.opacity = '0';
            message.style.transform = 'translateY(-10px)';
        }, index * 50);
    });
    
    // Wait for animation to complete, then clear and show welcome
    setTimeout(() => {
        // Clear the chat container
        document.getElementById('chatContainer').innerHTML = '';
        
        // Show new chat greeting
        showNewChatGreeting();
    }, (messages.length * 50) + 300);
}

// 4. Make sure your addImprovedStyles function is correctly defined
function addImprovedStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* Friendlier message bubbles */
        .message-content {
            border-radius: 24px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .message.bot .message-content {
            border-bottom-left-radius: 8px;
            box-shadow: 0 6px 15px -5px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-light);
        }
        
        .message.user .message-content {
            border-bottom-right-radius: 8px;
            box-shadow: 0 6px 15px -5px rgba(99, 102, 241, 0.3);
        }
        
        /* Improved avatars */
        .message-avatar, .user-avatar {
            transition: transform 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .message:hover .message-avatar, .message:hover .user-avatar {
            transform: scale(1.05);
        }
        
        /* Chat container improvements */
        .chat-container {
            padding: 32px 32px 16px 32px;
            scroll-padding-bottom: 16px;
        }
        
        /* Chat session indicator */
        .chat-session-indicator {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--text-light);
            opacity: 0.8;
            padding: 6px 12px;
            background-color: rgba(99, 102, 241, 0.08);
            border-radius: 30px;
            width: fit-content;
            margin: 0 auto 24px auto;
            transition: all 0.3s ease;
        }
        
        .chat-session-indicator:hover {
            opacity: 1;
            background-color: rgba(99, 102, 241, 0.12);
        }
        
        /* Message grouping for better readability */
        .message.bot + .message.bot,
        .message.user + .message.user {
            margin-top: calc(var(--message-spacing) * 0.4);
        }
        
        .message.bot + .message.bot .message-avatar,
        .message.user + .message.user .user-avatar {
            opacity: 0;
        }
        
        /* Animation for new messages */
        .message {
            animation: messageSlideIn 0.4s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Enhanced typing indicator */
        .typing-indicator {
            border-radius: 18px 18px 18px 4px;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
            border-left: 3px solid var(--primary-light);
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }
        
        /* Input area improvements */
        .input-container {
            border-top: 1px solid rgba(99, 102, 241, 0.1);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.5) 0%, rgba(255, 255, 255, 1) 100%);
            backdrop-filter: blur(10px);
        }
        
        textarea {
            border-color: rgba(99, 102, 241, 0.2);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        /* Enhanced send button glow effect */
        .send-button {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.4);
        }
        
        .send-button:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.6);
        }
        
        /* Message hover effects */
        .message-content:hover {
            transform: translateY(-2px) scale(1.01);
        }
        
        /* Feature buttons more noticeable */
        .feature-button {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .feature-button:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: translateY(-4px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
        }
        
        /* Welcome screen improvements */
        .welcome-screen {
            animation: fadeScale 1s ease-out;
        }
        
        @keyframes fadeScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .welcome-icon {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(99, 102, 241, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }
        
        /* Improved history styles */
        .history-session {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 10px;
        }
        
        .history-session:hover {
            background-color: rgba(99, 102, 241, 0.05);
            transform: translateX(4px);
            border-left: 4px solid var(--primary-light);
        }
        
        .history-session-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 15px;
            margin-top: 5px;
            padding-bottom: 5px;
        }
        
        .history-modal-content {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        
        .history-modal-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }
        
        .history-modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }
    `;
    document.head.appendChild(style);
}

// Add these styles to your existing addImprovedStyles function or create a new function
function enhanceHistoryInterfaceStyling() {
    const style = document.createElement('style');
    style.textContent = `
        /* Enhanced History Modal */
        .history-modal {
            backdrop-filter: blur(8px);
        }
        
        .history-modal-content {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .history-modal-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .history-modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        #closeHistoryModal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        #closeHistoryModal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .history-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .history-modal-footer {
            padding: 16px 20px;
            background: #F9FAFB;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: flex-end;
        }
        
        #clearHistoryButton {
            background-color: #F3F4F6;
            color: var(--text);
            border: 1px solid #E5E7EB;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        #clearHistoryButton:hover {
            background-color: #E5E7EB;
        }
        
        /* Enhanced History Session Cards */
        .history-session {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .history-session:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
            border-left: 4px solid var(--primary-light);
        }
        
        .history-session-header {
            padding: 12px 16px;
            background-color: #F9FAFB;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .history-date {
            color: var(--text-light);
            font-size: 0.85em;
            flex: 1;
        }
        
        .history-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .edit-session-title, 
        .delete-session-button {
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .edit-session-title:hover {
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            transform: scale(1.1);
        }
        
        .delete-session-button:hover {
            background-color: rgba(244, 63, 94, 0.1);
            color: #F43F5E;
            transform: scale(1.1);
        }
        
        .restore-session {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .restore-session svg {
            width: 16px;
            height: 16px;
        }
        
        .restore-session:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
        }
        
        .history-session-content {
            padding: 12px 16px;
        }
        
        .history-session-title {
            font-weight: 600;
            color: var(--text);
            font-size: 15px;
            margin-bottom: 8px;
        }
        
        .history-session-title.has-title {
            color: var(--primary);
        }
        
        .history-session-snippet {
            color: var(--text-light);
            font-size: 13px;
            line-height: 1.5;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        /* Empty and Error States */
        .empty-history, 
        .error-history {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .empty-history svg,
        .error-history svg {
            width: 60px;
            height: 60px;
            color: var(--text-light);
            opacity: 0.5;
        }
        
        /* Session confirmation dialog */
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        
        .confirmation-dialog-content {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .confirmation-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 12px;
            color: var(--text);
        }
        
        .confirmation-message {
            margin-bottom: 24px;
            color: var(--text-light);
            line-height: 1.5;
        }
        
        .confirmation-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .confirmation-cancel,
        .confirmation-confirm {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .confirmation-cancel {
            background-color: #F3F4F6;
            color: var(--text);
            border: 1px solid #E5E7EB;
        }
        
        .confirmation-confirm {
            background-color: #F43F5E;
            color: white;
            border: none;
        }
        
        .confirmation-cancel:hover {
            background-color: #E5E7EB;
        }
        
        .confirmation-confirm:hover {
            background-color: #E11D48;
        }
    `;
    
    document.head.appendChild(style);
}

function initializeNewFeatures() {
    addNewChatButton();
    enhanceHistoryFeature();
    initializeCurrentSession();
    addOptionsMenu();
    addOptionsMenuStyles();
    addExportFeature();
    addSummarizationFeature(); // Add this
    addActionItemsFeature(); // Add this if you want it
    addKeyboardShortcuts(); // Add this if you want keyboard shortcuts
    
    // Add styles for new elements
    const style = document.createElement('style');
    style.textContent = `
        #newChatButton {
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: var(--transition);
            margin-right: 8px;
        }
        
        #newChatButton:hover {
            transform: scale(1.1);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .edit-session-title {
            background: none;
            border: none;
            cursor: pointer;
            padding: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .edit-session-title:hover {
            color: var(--primary);
            transform: scale(1.1);
        }
        
        .delete-session-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .delete-session-button:hover {
            color: #F43F5E;
            transform: scale(1.1);
        }
        
        .history-session-title {
            font-weight: 500;
            margin-top: 5px;
            color: var(--text);
        }
    `;
    document.head.appendChild(style);
}

            // Initialize all new features
function initializeNewFeatures() {
    addNewChatButton();
    enhanceHistoryFeature();
    initializeCurrentSession();
    addOptionsMenu();
    addOptionsMenuStyles();
    addSmartContextAwareness();
    enhanceVoiceCapabilities();
    addMessageFormattingToolbar();
    
    // Add styles for new elements
    const style = document.createElement('style');
    style.textContent = `
        #newChatButton {
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: var(--transition);
            margin-right: 8px;
        }
        
        #newChatButton:hover {
            transform: scale(1.1);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .edit-session-title {
            background: none;
            border: none;
            cursor: pointer;
            padding: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .edit-session-title:hover {
            color: var(--primary);
            transform: scale(1.1);
        }
        
        .history-session-title {
            font-weight: 500;
            margin-top: 5px;
            color: var(--text);
        }
    `;
    document.head.appendChild(style);
}

// Add this first - style improvements for a more friendly interface
function addImprovedStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* Friendlier message bubbles */
        .message-content {
            border-radius: 24px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .message.bot .message-content {
            border-bottom-left-radius: 8px;
            box-shadow: 0 6px 15px -5px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-light);
        }
        
        .message.user .message-content {
            border-bottom-right-radius: 8px;
            box-shadow: 0 6px 15px -5px rgba(99, 102, 241, 0.3);
        }
        
        /* Improved avatars */
        .message-avatar, .user-avatar {
            transition: transform 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .message:hover .message-avatar, .message:hover .user-avatar {
            transform: scale(1.05);
        }
        
        /* Chat container improvements */
        .chat-container {
            padding: 32px 32px 16px 32px;
            scroll-padding-bottom: 16px;
        }
        
        /* Chat session indicator */
        .chat-session-indicator {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--text-light);
            opacity: 0.8;
            padding: 6px 12px;
            background-color: rgba(99, 102, 241, 0.08);
            border-radius: 30px;
            width: fit-content;
            margin: 0 auto 24px auto;
            transition: all 0.3s ease;
        }
        
        .chat-session-indicator:hover {
            opacity: 1;
            background-color: rgba(99, 102, 241, 0.12);
        }
        
        /* Improved history session display */
        .history-session {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            margin-bottom: 12px;
        }
        
        .history-session:hover {
            background-color: rgba(99, 102, 241, 0.05);
            transform: translateX(4px);
            border-left: 4px solid var(--primary-light);
        }
        
        .history-session-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 15px;
            margin-top: 5px;
            padding-bottom: 5px;
        }
        
        .history-session-snippet {
            color: var(--text-light);
            font-size: 13px;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 95%;
        }
        
        /* Animation for smooth transitions */
        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .restore-session {
            transition: all 0.3s ease;
            transform: scale(1);
        }
        
        .restore-session:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
    `;
    document.head.appendChild(style);
}

            // Initialize the interface
            function initializeApp() {
                // Focus input field
                userInput.focus();
                
                // Initialize glow effect
                glowContainer.style.left = '200px';
                glowContainer.style.top = '200px';
                
                // Initialize font size slider
                updateFontSizeValue();
                
                // Initialize response length slider
                updateResponseLengthValue();
                
                // Initialize creativity slider
                if (creativityRange) updateCreativityValue();
                
                // Make sure typingAnimToggle is checked by default
                typingAnimToggle.checked = true;
                
                // Add a welcome message after a slight delay
                setTimeout(() => {
                    // Hide welcome screen
                    welcomeScreen.style.display = 'none';
                    
                    // Add first bot message
                    addMessage("👋 Hello! I'm Nexus AI, your intelligent assistant. How can I help you today?");
                }, 1000);
                
                // Initialize voice visualizations
                initVoiceWave();
                
                // Add conversation history feature
                addConversationHistory();
                
                // Load settings if they exist
                const savedSettings = localStorage.getItem('nexusSettings');
                if (savedSettings) {
                    try {
                        const settings = JSON.parse(savedSettings);
                        if (settings.darkMode !== undefined) darkModeToggle.checked = settings.darkMode;
                        if (settings.sound !== undefined) soundToggle.checked = settings.sound;
                        if (settings.typingAnim !== undefined) typingAnimToggle.checked = settings.typingAnim;
                        if (settings.autoScroll !== undefined) autoScrollToggle.checked = settings.autoScroll;
                        if (settings.fontSize) fontSizeRange.value = settings.fontSize;
                        if (settings.responseLength) responseLengthRange.value = settings.responseLength;
                        if (settings.theme) changeTheme(settings.theme);
                        if (settings.font) changeFont(settings.font);
                        
                        // Apply settings
                        toggleDarkMode();
                        updateFontSizeValue();
                        updateResponseLengthValue();
                    } catch (e) {
                        console.error('Error loading settings:', e);

                         // Add export feature
    addExportFeature();
                    }
                }

                initializeNewFeatures();
            }

            // Add Export functionality to the header actions
function addExportFeature() {
    const headerActions = document.querySelector('.actions');
    
    // Create export button
    const exportButton = document.createElement('svg');
    exportButton.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    exportButton.setAttribute('fill', 'none');
    exportButton.setAttribute('viewBox', '0 0 24 24');
    exportButton.setAttribute('stroke', 'currentColor');
    exportButton.id = 'exportButton';
    exportButton.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
    `;
    exportButton.title = "Export Chat";
    headerActions.insertBefore(exportButton, headerActions.firstChild);
    
    // Create export dropdown menu
    const exportMenu = document.createElement('div');
    exportMenu.classList.add('export-dropdown');
    exportMenu.innerHTML = `
        <button class="export-option" data-format="pdf">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span>Export as PDF</span>
        </button>
        <button class="export-option" data-format="html">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
            </svg>
            <span>Export as HTML</span>
        </button>
        <button class="export-option" data-format="text">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span>Export as Text</span>
        </button>
    `;
    
    document.body.appendChild(exportMenu);
    
    // Toggle export menu
    exportButton.addEventListener('click', () => {
        exportMenu.classList.toggle('active');
    });
    
    // Handle export options
    document.querySelectorAll('.export-option').forEach(option => {
        option.addEventListener('click', () => {
            const format = option.getAttribute('data-format');
            exportChat(format);
            exportMenu.classList.remove('active');
        });
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!exportButton.contains(e.target) && !exportMenu.contains(e.target)) {
            exportMenu.classList.remove('active');
        }
    });
}

// Export chat function
function exportChat(format) {
    const messages = document.querySelectorAll('.message');
    const chatTitle = "Nexus AI Chat - " + new Date().toLocaleString();
    let content = '';
    
    // Generate content based on format
    switch(format) {
        case 'pdf':
            // Using html2pdf.js library for PDF conversion
            // First, create HTML content
            content = `
                <div class="exported-chat">
                    <h1>${chatTitle}</h1>
                    <div class="chat-messages">
                        ${Array.from(messages).map(msg => {
                            const isUser = msg.classList.contains('user');
                            const msgContent = msg.querySelector('.message-content').innerHTML;
                            const time = msg.querySelector('.message-time').textContent;
                            return `
                                <div class="chat-message ${isUser ? 'user-message' : 'bot-message'}">
                                    <div class="message-sender">${isUser ? 'You' : 'Nexus AI'}</div>
                                    <div class="message-text">${msgContent}</div>
                                    <div class="message-time">${time}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
           // Create styled element for PDF export
    const pdfElement = document.createElement('div');
    pdfElement.innerHTML = content;
    pdfElement.style.padding = '20px';
    document.body.appendChild(pdfElement);
            
            // Use html2pdf library
    html2pdf()
        .from(pdfElement)
        .save(chatTitle + '.pdf')
        .then(() => {
            pdfElement.remove();
        });
    break;
            
        case 'html':
            // Create HTML document
            content = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${chatTitle}</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                        .chat-message { margin-bottom: 20px; padding: 15px; border-radius: 10px; }
                        .user-message { background-color: #e6f7ff; margin-left: 50px; }
                        .bot-message { background-color: #f5f5f5; margin-right: 50px; }
                        .message-sender { font-weight: bold; margin-bottom: 5px; }
                        .message-time { font-size: 12px; color: #888; margin-top: 5px; text-align: right; }
                        h1 { text-align: center; color: #333; }
                    </style>
                </head>
                <body>
                    <h1>${chatTitle}</h1>
                    <div class="chat-messages">
                        ${Array.from(messages).map(msg => {
                            const isUser = msg.classList.contains('user');
                            const msgContent = msg.querySelector('.message-content').innerHTML;
                            const time = msg.querySelector('.message-time').textContent;
                            return `
                                <div class="chat-message ${isUser ? 'user-message' : 'bot-message'}">
                                    <div class="message-sender">${isUser ? 'You' : 'Nexus AI'}</div>
                                    <div class="message-text">${msgContent}</div>
                                    <div class="message-time">${time}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </body>
                </html>
            `;
            
            // Create download link
            downloadFile(content, chatTitle + '.html', 'text/html');
            break;
            
        case 'text':
            // Create plain text content
            content = `${chatTitle}\n\n`;
            messages.forEach(msg => {
                const isUser = msg.classList.contains('user');
                const sender = isUser ? 'You' : 'Nexus AI';
                const msgContent = msg.querySelector('.message-content').textContent.trim();
                const time = msg.querySelector('.message-time').textContent;
                
                content += `[${time}] ${sender}:\n${msgContent}\n\n`;
            });
            
            // Create download link
            downloadFile(content, chatTitle + '.txt', 'text/plain');
            break;
    }
}

// Helper function to download files
function downloadFile(content, fileName, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(url);
}

// Add summarization button to the header
function addSummarizationFeature() {
    const headerActions = document.querySelector('.actions');
    
    // Create summarize button
    const summarizeButton = document.createElement('svg');
    summarizeButton.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    summarizeButton.setAttribute('fill', 'none');
    summarizeButton.setAttribute('viewBox', '0 0 24 24');
    summarizeButton.setAttribute('stroke', 'currentColor');
    summarizeButton.id = 'summarizeButton';
    summarizeButton.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16" />
    `;
    summarizeButton.title = "Summarize Chat";
    
    headerActions.insertBefore(summarizeButton, headerActions.firstChild);
    
    // Add click event to generate summary
    summarizeButton.addEventListener('click', generateChatSummary);
}

// Function to generate chat summary
function generateChatSummary() {
    // Get all messages and check if there are enough to summarize
    const messages = document.querySelectorAll('.message');
    
    if (messages.length < 4) {
        alert("The conversation is too short to summarize.");
        return;
    }
    
    // Display "generating summary" indicator
    const typingIndicator = document.getElementById('typingIndicator');
    typingIndicator.classList.add('active');
    
    // For a real app, you would use AI to generate the summary
    // This is a mock implementation that extracts key points
    
    setTimeout(() => {
        // Hide typing indicator
        typingIndicator.classList.remove('active');
        
        // Extract all user messages (questions/inputs)
        const userMessages = Array.from(messages).filter(msg => msg.classList.contains('user'));
        
        // Create a summary overlay
        const summaryOverlay = document.createElement('div');
        summaryOverlay.classList.add('summary-overlay');
        
        // Generate a mock summary
        let topicsList = '';
        userMessages.forEach((msg, index) => {
            if (index < 5) {  // Limit to 5 top topics
                const content = msg.querySelector('.message-content').textContent.trim();
                topicsList += `<li>${content.substring(0, 60)}${content.length > 60 ? '...' : ''}</li>`;
            }
        });
        
        // Create the summary content
        summaryOverlay.innerHTML = `
            <div class="summary-container">
                <div class="summary-header">
                    <h2>Conversation Summary</h2>
                    <button class="summary-close">×</button>
                </div>
                <div class="summary-content">
                    <div class="summary-section">
                        <h3>Main Topics Discussed</h3>
                        <ul>${topicsList}</ul>
                    </div>
                    <div class="summary-section">
                        <h3>Key Insights</h3>
                        <p>This conversation covered ${userMessages.length} questions about Nexus AI functionality.</p>
                        <p>The main focus was on interface improvements and user experience enhancements.</p>
                    </div>
                    <div class="summary-section">
                        <h3>Action Items</h3>
                        <ul>
                            <li>Implement new UI features</li>
                            <li>Update styling for better user experience</li>
                            <li>Enhance productivity tools</li>
                        </ul>
                    </div>
                </div>
                <div class="summary-footer">
                    <button class="summary-download">Download Summary</button>
                    <button class="summary-copy">Copy to Clipboard</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(summaryOverlay);
        
        // Add event listeners
        summaryOverlay.querySelector('.summary-close').addEventListener('click', () => {
            summaryOverlay.remove();
        });
        
        summaryOverlay.querySelector('.summary-download').addEventListener('click', () => {
            const content = summaryOverlay.querySelector('.summary-content').textContent;
            downloadFile(content, 'Chat Summary.txt', 'text/plain');
        });
        
        summaryOverlay.querySelector('.summary-copy').addEventListener('click', () => {
            const content = summaryOverlay.querySelector('.summary-content').textContent;
            navigator.clipboard.writeText(content).then(() => {
                alert('Summary copied to clipboard!');
            });
        });
        
        // Click outside to close
        summaryOverlay.addEventListener('click', (e) => {
            if (e.target === summaryOverlay) {
                summaryOverlay.remove();
            }
        });
        
        // Animation to slide in
        setTimeout(() => {
            summaryOverlay.classList.add('active');
        }, 10);
    }, 1500);
}

// Add action items extraction feature
function addActionItemsFeature() {
    const headerActions = document.querySelector('.actions');
    
    // Create action items button
    const actionItemsButton = document.createElement('svg');
    actionItemsButton.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    actionItemsButton.setAttribute('fill', 'none');
    actionItemsButton.setAttribute('viewBox', '0 0 24 24');
    actionItemsButton.setAttribute('stroke', 'currentColor');
    actionItemsButton.id = 'actionItemsButton';
    actionItemsButton.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    `;
    actionItemsButton.title = "Extract Action Items";
    
    headerActions.insertBefore(actionItemsButton, headerActions.firstChild);
    
    // Add click event to extract action items
    actionItemsButton.addEventListener('click', extractActionItems);
}

// Function to extract action items from chat
function extractActionItems() {
    const messages = document.querySelectorAll('.message');
    
    // Display processing indicator
    const typingIndicator = document.getElementById('typingIndicator');
    typingIndicator.classList.add('active');
    
    setTimeout(() => {
        // Hide typing indicator
        typingIndicator.classList.remove('active');
        
        // Mock function to extract action items
        // For a real implementation, you would use AI/NLP to identify action items
        
        // Create action items overlay
        const actionItemsOverlay = document.createElement('div');
        actionItemsOverlay.classList.add('action-items-overlay');
        
        // Find message content that starts with action-related phrases
        const actionPhrases = ['implement', 'add', 'create', 'build', 'develop', 'design', 'update', 'modify'];
        let actionItems = [];
        
        messages.forEach(msg => {
            const content = msg.querySelector('.message-content').textContent.toLowerCase();
            
            // Basic extraction - find sentences containing action phrases
            content.split('.').forEach(sentence => {
                actionPhrases.forEach(phrase => {
                    if (sentence.includes(phrase) && !actionItems.includes(sentence.trim())) {
                        actionItems.push(sentence.trim());
                    }
                });
            });
        });
        
        // Filter and clean up action items
        actionItems = actionItems.map(item => {
            // Capitalize first letter
            return item.charAt(0).toUpperCase() + item.slice(1);
        }).filter(item => item.length > 10);  // Remove too-short items
        
        // If no action items found, add a message
        if (actionItems.length === 0) {
            actionItems.push("No specific action items detected in this conversation.");
        }
        
        // Create action items content
        let actionItemsHTML = '';
        actionItems.forEach((item, index) => {
            actionItemsHTML += `
                <div class="action-item">
                    <input type="checkbox" id="action-${index}" class="action-checkbox">
                    <label for="action-${index}">${item}</label>
                </div>
            `;
        });
        
        actionItemsOverlay.innerHTML = `
            <div class="action-items-container">
                <div class="action-items-header">
                    <h2>Action Items</h2>
                    <button class="action-items-close">×</button>
                </div>
                <div class="action-items-content">
                    ${actionItemsHTML}
                </div>
                <div class="action-items-footer">
                    <button class="action-items-export">Export to Task List</button>
                    <button class="action-items-copy">Copy to Clipboard</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(actionItemsOverlay);
        
        // Add event listeners
        actionItemsOverlay.querySelector('.action-items-close').addEventListener('click', () => {
            actionItemsOverlay.remove();
        });
        
        actionItemsOverlay.querySelector('.action-items-export').addEventListener('click', () => {
            // Mock export to task list
            alert('In a real implementation, this would export to your task management system.');
        });
        
        actionItemsOverlay.querySelector('.action-items-copy').addEventListener('click', () => {
            const content = Array.from(actionItemsOverlay.querySelectorAll('.action-item label'))
                .map(label => `- ${label.textContent}`)
                .join('\n');
                
            navigator.clipboard.writeText(content).then(() => {
                alert('Action items copied to clipboard!');
            });
        });
        
        // Click outside to close
        actionItemsOverlay.addEventListener('click', (e) => {
            if (e.target === actionItemsOverlay) {
                actionItemsOverlay.remove();
            }
        });
        
        // Animation to slide in
        setTimeout(() => {
            actionItemsOverlay.classList.add('active');
        }, 10);
    }, 1000);
}

// Add keyboard shortcuts functionality
function addKeyboardShortcuts() {
    // Create keyboard shortcuts handler
    document.addEventListener('keydown', (e) => {
        // Cmd/Ctrl + Enter to send message
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
            processUserMessage();
        }
        
        // Cmd/Ctrl + K to show keyboard shortcuts help
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            showKeyboardShortcutsHelp();
        }
        
        // Esc to close active overlays
        if (e.key === 'Escape') {
            // Close any active overlay
            const activeOverlays = document.querySelectorAll('.summary-overlay.active, .action-items-overlay.active, .keyboard-shortcuts-overlay.active');
            if (activeOverlays.length > 0) {
                activeOverlays.forEach(overlay => overlay.remove());
            }
            
            // Close settings sidebar if open
            const settingsSidebar = document.getElementById('settingsSidebar');
            if (settingsSidebar && settingsSidebar.classList.contains('active')) {
                settingsSidebar.classList.remove('active');
                document.getElementById('sidebarOverlay').classList.remove('active');
            }
        }
        
        // Cmd/Ctrl + N for new chat
        if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
            e.preventDefault();
            if (window.startNewChatWithGreeting) {
                startNewChatWithGreeting();
            }
        }
        
        // Cmd/Ctrl + E for export
        if ((e.metaKey || e.ctrlKey) && e.key === 'e') {
            e.preventDefault();
            // Toggle export menu if it exists
            const exportMenu = document.querySelector('.export-dropdown');
            if (exportMenu) {
                exportMenu.classList.toggle('active');
            }
        }
    });
    
    // Add keyboard shortcuts button to header
    const headerActions = document.querySelector('.actions');
    const shortcutsButton = document.createElement('svg');
    shortcutsButton.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    shortcutsButton.setAttribute('fill', 'none');
    shortcutsButton.setAttribute('viewBox', '0 0 24 24');
    shortcutsButton.setAttribute('stroke', 'currentColor');
    shortcutsButton.id = 'shortcutsButton';
    shortcutsButton.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
    `;
    shortcutsButton.title = "Keyboard Shortcuts";
    
    headerActions.insertBefore(shortcutsButton, headerActions.firstChild);
    
    // Add click event to show keyboard shortcuts
    shortcutsButton.addEventListener('click', showKeyboardShortcutsHelp);
}

// Function to show keyboard shortcuts help overlay
function showKeyboardShortcutsHelp() {
    // Create keyboard shortcuts overlay
    const shortcutsOverlay = document.createElement('div');
    shortcutsOverlay.classList.add('keyboard-shortcuts-overlay');
    
    shortcutsOverlay.innerHTML = `
        <div class="keyboard-shortcuts-container">
            <div class="shortcuts-header">
                <h2>Keyboard Shortcuts</h2>
                <button class="shortcuts-close">×</button>
            </div>
            <div class="shortcuts-content">
                <div class="shortcuts-section">
                    <h3>Chat Navigation</h3>
                    <div class="shortcut-item">
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span> + <span class="key">N</span>
                        </div>
                        <div class="shortcut-desc">Start new chat</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span> + <span class="key">↑</span>
                        </div>
                        <div class="shortcut-desc">Previous chat</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span> + <span class="key">↓</span>
                        </div>
                        <div class="shortcut-desc">Next chat</div>
                    </div>
                </div>
                
                <div class="shortcuts-section">
                    <h3>Composing Messages</h3>
                    <div class="shortcut-item">
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span> + <span class="key">Enter</span>
                        </div>
                        <div class="shortcut-desc">Send message</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys">
                            <span class="key">Shift</span> + <span class="key">Enter</span>
                        </div>
                        <div class="shortcut-desc">New line</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys">
                            <span class="key">Alt</span> + <span class="key">V</span>
                        </div>
                        <div class="shortcut-desc">Voice input</div>
                    </div>
                </div>
                
                <div class="shortcuts-section">
                    <h3>Tools & Features</h3>
                    <div class="shortcut-item">
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span> + <span class="key">E</span>
                        </div>
                        <div class="shortcut-desc">Export chat</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span> + <span class="key">S</span>
                        </div>
                        <div class="shortcut-desc">Summarize chat</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span> + <span class="key">A</span>
                        </div>
                        <div class="shortcut-desc">Extract action items</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span> + <span class="key">,</span>
                        </div>
                        <div class="shortcut-desc">Open settings</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span> + <span class="key">K</span>
                        </div>
                        <div class="shortcut-desc">Show this dialog</div>
                    </div>
                </div>
            </div>
            <div class="shortcuts-footer">
                <span>Tip: On Mac, use <span class="key">⌘</span> instead of <span class="key">Ctrl</span></span>
            </div>
        </div>
    `;
    
    document.body.appendChild(shortcutsOverlay);
    
    // Add event listeners
    shortcutsOverlay.querySelector('.shortcuts-close').addEventListener('click', () => {
        shortcutsOverlay.remove();
    });
    
    // Click outside to close
    shortcutsOverlay.addEventListener('click', (e) => {
        if (e.target === shortcutsOverlay) {
            shortcutsOverlay.remove();
        }
    });
    
    // Animation to slide in
    setTimeout(() => {
        shortcutsOverlay.classList.add('active');
    }, 10);
}
            // Call the initialization function
            initializeApp();
            initializeEnhancedFeatures();
        });
    </script>
</body>
</html>